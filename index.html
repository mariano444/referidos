<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Referidos</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <!-- PreconexiÃ³n y fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  /* Base styles */
:root {
  --primary: 221 83% 53%;
  --primary-foreground: 210 40% 98%;
  --secondary: 210 40% 96.1%;
  --secondary-foreground: 222.2 47.4% 11.2%;
  --background: 0 0% 100%;
  --foreground: 222.2 84% 4.9%;
  --card: 0 0% 100%;
  --card-foreground: 222.2 84% 4.9%;
  --border: 214.3 31.8% 91.4%;
  --input: 214.3 31.8% 91.4%;
  --ring: 221 83% 53%;
  --radius: 0.5rem;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans",
    "Helvetica Neue", sans-serif;
  color: hsl(var(--foreground));
  background-color: white;
  line-height: 1.5;
}

/* Utility classes */
.min-h-screen {
  min-height: 100vh;
}

.bg-gradient-to-b {
  background-image: linear-gradient(to bottom, var(--tw-gradient-stops));
}

.from-blue-100 {
  --tw-gradient-from: #dbeafe;
  --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(219, 234, 254, 0));
}

.to-white {
  --tw-gradient-to: #ffffff;
}

.p-4 {
  padding: 1rem;
}

.md\:p-8 {
  padding: 2rem;
}

.max-w-4xl {
  max-width: 56rem;
}

.mx-auto {
  margin-left: auto;
  margin-right: auto;
}

.text-3xl {
  font-size: 1.875rem;
  line-height: 2.25rem;
}

.md\:text-5xl {
  font-size: 3rem;
  line-height: 1;
}

.font-bold {
  font-weight: 700;
}

.text-center {
  text-align: center;
}

.mb-2 {
  margin-bottom: 0.5rem;
}

.bg-clip-text {
  -webkit-background-clip: text;
  background-clip: text;
}

.text-transparent {
  color: transparent;
}

.bg-gradient-to-r {
  background-image: linear-gradient(to right, var(--tw-gradient-stops));
}

.from-blue-600 {
  --tw-gradient-from: #2563eb;
  --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(37, 99, 235, 0));
}

.to-purple-600 {
  --tw-gradient-to: #9333ea;
}

.text-blue-600 {
  color: #2563eb;
}

.mb-8 {
  margin-bottom: 2rem;
}

.max-w-xl {
  max-width: 36rem;
}

/* Fixed elements */
.fixed {
  position: fixed;
}

.inset-0 {
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
}

.flex {
  display: flex;
}

.items-center {
  align-items: center;
}

.justify-center {
  justify-content: center;
}

.z-50 {
  z-index: 50;
}

.bg-black\/30 {
  background-color: rgba(0, 0, 0, 0.3);
}

.backdrop-blur-sm {
  backdrop-filter: blur(4px);
}

.hidden {
  display: none;
}

/* Celebration modal */
.celebration-modal {
  animation: scale-in 0.3s ease-out;
}

@keyframes scale-in {
  from {
    transform: scale(0.5) translateY(100px);
    opacity: 0;
  }
  to {
    transform: scale(1) translateY(0);
    opacity: 1;
  }
}

.relative {
  position: relative;
}

.z-10 {
  z-index: 10;
}

.absolute {
  position: absolute;
}

.inset-0 {
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
}

.overflow-hidden {
  overflow: hidden;
}

.blur-xl {
  filter: blur(24px);
}

.bg-yellow-400 {
  background-color: #facc15;
}

.rounded-full {
  border-radius: 9999px;
}

.opacity-50 {
  opacity: 0.5;
}

.animate-pulse {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.h-20 {
  height: 5rem;
}

.w-20 {
  width: 5rem;
}

.mx-auto {
  margin-left: auto;
  margin-right: auto;
}

.mb-4 {
  margin-bottom: 1rem;
}

.text-yellow-300 {
  color: #fcd34d;
}

.party-popper-container {
  animation: wobble 1s ease-in-out;
}

@keyframes wobble {
  0%,
  100% {
    transform: rotate(0);
  }
  25% {
    transform: rotate(10deg);
  }
  50% {
    transform: rotate(-10deg);
  }
  75% {
    transform: rotate(10deg);
  }
}

.celebration-title {
  animation: scale-pulse 1s ease-in-out 2;
}

@keyframes scale-pulse {
  0%,
  100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.2);
  }
}

.text-3xl {
  font-size: 1.875rem;
  line-height: 2.25rem;
}

.font-bold {
  font-weight: 700;
}

.text-2xl {
  font-size: 1.5rem;
  line-height: 2rem;
}

.from-yellow-300 {
  --tw-gradient-from: #fcd34d;
  --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(252, 211, 77, 0));
}

.to-white {
  --tw-gradient-to: #ffffff;
}

.mt-6 {
  margin-top: 1.5rem;
}

.flex-col {
  flex-direction: column;
}

.bg-white {
  background-color: #ffffff;
}

.text-blue-600 {
  color: #2563eb;
}

.hover\:bg-blue-50:hover {
  background-color: #eff6ff;
}

.text-lg {
  font-size: 1.125rem;
  line-height: 1.75rem;
}

.px-8 {
  padding-left: 2rem;
  padding-right: 2rem;
}

.py-6 {
  padding-top: 1.5rem;
  padding-bottom: 1.5rem;
}

.shadow-lg {
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.transform {
  transform: translateX(0) translateY(0) rotate(0) skewX(0) skewY(0) scaleX(1) scaleY(1);
}

.transition {
  transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}

.hover\:scale-105:hover {
  transform: scale(1.05);
}

.mt-4 {
  margin-top: 1rem;
}

.text-sm {
  font-size: 0.875rem;
  line-height: 1.25rem;
}

.text-blue-100 {
  color: #dbeafe;
}

.mt-2 {
  margin-top: 0.5rem;
}

.btn-ghost {
  background-color: transparent;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.375rem;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
}

.hover\:bg-white\/20:hover {
  background-color: rgba(255, 255, 255, 0.2);
}

.mr-2 {
  margin-right: 0.5rem;
}

.h-4 {
  height: 1rem;
}

.w-4 {
  width: 1rem;
}

.inline-block {
  display: inline-block;
}

/* Sparkles */
.sparkles-container {
  position: absolute;
  inset: 0;
  overflow: hidden;
}

.sparkle {
  position: absolute;
  width: 8px;
  height: 8px;
  background-color: white;
  border-radius: 50%;
  opacity: 0.7;
  animation: sparkle-animation 3s infinite;
}

@keyframes sparkle-animation {
  0% {
    transform: scale(0);
    opacity: 0;
  }
  50% {
    transform: scale(1);
    opacity: 0.7;
  }
  100% {
    transform: scale(0);
    opacity: 0;
  }
}

/* Tips popup */
.bottom-4 {
  bottom: 1rem;
}

.right-4 {
  right: 1rem;
}

.max-w-xs {
  max-width: 20rem;
}

.from-amber-500 {
  --tw-gradient-from: #f59e0b;
  --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(245, 158, 11, 0));
}

.to-orange-500 {
  --tw-gradient-to: #f97316;
}

.p-4 {
  padding: 1rem;
}

.rounded-lg {
  border-radius: 0.5rem;
}

.shadow-lg {
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.text-white {
  color: #ffffff;
}

.z-40 {
  z-index: 40;
}

.items-start {
  align-items: flex-start;
}

.mt-0\.5 {
  margin-top: 0.125rem;
}

.flex-shrink-0 {
  flex-shrink: 0;
}

.font-bold {
  font-weight: 700;
}

.text-xs {
  font-size: 0.75rem;
  line-height: 1rem;
}

.ml-2 {
  margin-left: 0.5rem;
}

.text-white\/70 {
  color: rgba(255, 255, 255, 0.7);
}

.hover\:text-white:hover {
  color: #ffffff;
}

/* Streak badge */
.top-4 {
  top: 1rem;
}

.px-4 {
  padding-left: 1rem;
  padding-right: 1rem;
}

.py-2 {
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
}

.from-red-500 {
  --tw-gradient-from: #ef4444;
  --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(239, 68, 68, 0));
}

.to-orange-500 {
  --tw-gradient-to: #f97316;
}

/* Limited time offer */
.mb-6 {
  margin-bottom: 1.5rem;
}

.p-4 {
  padding: 1rem;
}

.bg-white\/20 {
  background-color: rgba(255, 255, 255, 0.2);
}

.p-2 {
  padding: 0.5rem;
}

.h-6 {
  height: 1.5rem;
}

.w-6 {
  width: 1.5rem;
}

.text-lg {
  font-size: 1.125rem;
  line-height: 1.75rem;
}

.text-white\/90 {
  color: rgba(255, 255, 255, 0.9);
}

.mt-3 {
  margin-top: 0.75rem;
}

.h-1\.5 {
  height: 0.375rem;
}

/* Dashboard header */
.md\:flex-row {
  flex-direction: row;
}

.md\:items-center {
  align-items: center;
}

.justify-between {
  justify-content: space-between;
}

.md\:mb-0 {
  margin-bottom: 0;
}

.space-x-2 > * + * {
  margin-left: 0.5rem;
}

.tooltip {
  position: relative;
  display: inline-block;
}

.tooltip .tooltiptext {
  visibility: hidden;
  width: 120px;
  background-color: #333;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -60px;
  opacity: 0;
  transition: opacity 0.3s;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}

.btn-outline {
  background-color: transparent;
  border: 1px solid;
  padding: 0.5rem 1rem;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
}

.border-white\/20 {
  border-color: rgba(255, 255, 255, 0.2);
}

.badge {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.5rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
  line-height: 1;
  border: 1px solid;
}

.h-3 {
  height: 0.75rem;
}

.w-3 {
  width: 0.75rem;
}

/* Next reward progress */
.h-2 {
  height: 0.5rem;
}

.bg-blue-900\/50 {
  background-color: rgba(30, 58, 138, 0.5);
}

.from-blue-300 {
  --tw-gradient-from: #93c5fd;
  --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(147, 197, 253, 0));
}

.to-purple-300 {
  --tw-gradient-to: #c4b5fd;
}

/* Main progress bar */
.progress-container {
  width: 100%;
  height: 0.75rem;
  background-color: #dbeafe;
  border-radius: 9999px;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  background-image: linear-gradient(to right, #818cf8, #8b5cf6);
  background-repeat: no-repeat;
  transition: width 1s ease;
}

.text-blue-800 {
  color: #1e40af;
}

.text-blue-700 {
  color: #1d4ed8;
}

.bg-gray-300 {
  background-color: #d1d5db;
}

.bg-green-500 {
  background-color: #10b981;
}

/* Tabs */
.tabs-container {
  width: 100%;
}

.tabs-list {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  width: 100%;
  background-color: #f1f5f9;
  border-radius: 0.5rem;
  padding: 0.25rem;
  margin-bottom: 1rem;
}

.tab-trigger {
  padding: 0.5rem 1rem;
  text-align: center;
  font-size: 0.875rem;
  font-weight: 500;
  border-radius: 0.375rem;
  cursor: pointer;
  background: transparent;
  border: none;
  transition: background-color 0.2s, color 0.2s;
}

.tab-trigger.active {
  background-color: #2563eb;
  color: white;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* Pulse dot */
.pulse-dot {
  position: absolute;
  top: -4px;
  right: -4px;
  display: flex;
  height: 12px;
  width: 12px;
}

.ping {
  position: absolute;
  display: inline-flex;
  height: 100%;
  width: 100%;
  border-radius: 9999px;
  background-color: #f87171;
  opacity: 0.75;
  animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;
}

.dot {
  position: relative;
  display: inline-flex;
  height: 12px;
  width: 12px;
  border-radius: 9999px;
  background-color: #ef4444;
}

@keyframes ping {
  75%,
  100% {
    transform: scale(2);
    opacity: 0;
  }
}

/* Card */
.card {
  background-color: white;
  border-radius: 0.5rem;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  overflow: hidden;
}

.card-header {
  padding: 1.5rem;
  border-bottom: 1px solid #e5e7eb;
}

.card-title {
  font-size: 1.25rem;
  font-weight: 600;
  display: flex;
  align-items: center;
}

.card-description {
  margin-top: 0.25rem;
  font-size: 0.875rem;
  color: #6b7280;
}

.card-content {
  padding: 1.5rem;
}

.card-footer {
  padding: 1.5rem;
  border-top: 1px solid #e5e7eb;
}

.border-2 {
  border-width: 2px;
}

.border-blue-100 {
  border-color: #dbeafe;
}

.from-blue-50 {
  --tw-gradient-from: #eff6ff;
  --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(239, 246, 255, 0));
}

.to-purple-50 {
  --tw-gradient-to: #f5f3ff;
}

/* Form elements */
.space-y-4 > * + * {
  margin-top: 1rem;
}

.pt-6 {
  padding-top: 1.5rem;
}

.grid {
  display: grid;
}

.grid-cols-1 {
  grid-template-columns: repeat(1, minmax(0, 1fr));
}

.md\:grid-cols-2 {
  grid-template-columns: repeat(2, minmax(0, 1fr));
}

.gap-4 {
  gap: 1rem;
}

.animate-fade-in {
  animation: fade-in 0.5s ease-out;
}

.animate-fade-in-delay {
  animation: fade-in 0.5s ease-out 0.2s both;
}

.animate-fade-in-delay-long {
  animation: fade-in 0.5s ease-out 0.5s both;
}

.animate-fade-in-scale {
  animation: fade-in-scale 0.5s ease-out 0.3s both;
}

@keyframes fade-in {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fade-in-scale {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.space-y-2 > * + * {
  margin-top: 0.5rem;
}

.input {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border: 1px solid #e5e7eb;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
}

.select-wrapper {
  position: relative;
}

.select-wrapper::after {
  content: "";
  position: absolute;
  right: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  width: 0;
  height: 0;
  border-left: 5px solid transparent;
  border-right: 5px solid transparent;
  border-top: 5px solid #6b7280;
  pointer-events: none;
}

.select {
  width: 100%;
  padding: 0.5rem 2rem 0.5rem 0.75rem;
  border: 1px solid #e5e7eb;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
  appearance: none;
  background-color: white;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
}

.border {
  border-width: 1px;
}

.border-blue-100 {
  border-color: #dbeafe;
}

.mt-4 {
  margin-top: 1rem;
}

.text-green-600 {
  color: #059669;
}

.mt-6 {
  margin-top: 1.5rem;
}

.text-red-500 {
  color: #ef4444;
}

.mb-3 {
  margin-bottom: 0.75rem;
}

.md\:grid-cols-2 {
  grid-template-columns: repeat(2, minmax(0, 1fr));
}

.gap-3 {
  gap: 0.75rem;
}

.bg-white {
  background-color: white;
}

.p-3 {
  padding: 0.75rem;
}

.shadow-sm {
  box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}

.avatar {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 9999px;
  overflow: hidden;
  background-color: #e5e7eb;
}

.avatar-fallback {
  font-weight: 500;
  font-size: 0.75rem;
}

.text-yellow-400 {
  color: #facc15;
}

.fill-current {
  fill: currentColor;
}

.text-gray-600 {
  color: #4b5563;
}

.btn-primary {
  background-color: #2563eb;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.375rem;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
}

.btn-primary:hover {
  background-color: #1d4ed8;
}

.hover-scale {
  transition: transform 0.2s;
}

.hover-scale:hover {
  transform: scale(1.05);
}

.py-12 {
  padding-top: 3rem;
  padding-bottom: 3rem;
}

.text-gray-500 {
  color: #6b7280;
}

.text-blue-200 {
  color: #bfdbfe;
}

.text-xl {
  font-size: 1.25rem;
  line-height: 1.75rem;
}

.grid-cols-3 {
  grid-template-columns: repeat(3, minmax(0, 1fr));
}

.gap-2 {
  gap: 0.5rem;
}

.bg-blue-50 {
  background-color: #eff6ff;
}

.text-center {
  text-align: center;
}

.space-y-4 > * + * {
  margin-top: 1rem;
}

.justify-between {
  justify-content: space-between;
}

.bg-green-100 {
  background-color: #d1fae5;
}

.text-green-800 {
  color: #065f46;
}

/* Drawer */
.drawer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 50;
}

.drawer-overlay {
  position: fixed;
  inset: 0;
  background-color: rgba(0, 0, 0, 0.5);
}

.drawer-content {
  position: relative;
  background-color: white;
  border-top-left-radius: 0.75rem;
  border-top-right-radius: 0.75rem;
  padding: 1rem;
  margin-top: 1rem;
  max-height: 80vh;
  overflow-y: auto;
}

.drawer-header {
  padding: 1rem;
  text-align: center;
}

.drawer-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.drawer-description {
  font-size: 0.875rem;
  color: #6b7280;
}

.drawer-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: #6b7280;
}

.tracking-wider {
  letter-spacing: 0.05em;
}

/* Toast container */
.toast-container {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  z-index: 50;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.toast {
  background-color: white;
  color: #1f2937;
  border-radius: 0.375rem;
  padding: 1rem;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  max-width: 350px;
  animation: toast-in 0.3s ease-out;
}

.toast-title {
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.toast-description {
  font-size: 0.875rem;
}

.toast-success {
  background: linear-gradient(to right, #10b981, #059669);
  color: white;
}

.toast-error {
  background: linear-gradient(to right, #ef4444, #dc2626);
  color: white;
}

.toast-special {
  background: linear-gradient(to right, #8b5cf6, #6366f1);
  color: white;
}

@keyframes toast-in {
  from {
    transform: translateY(1rem);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* Loading spinner */
.loading-spinner {
  display: inline-block;
  width: 1.5rem;
  height: 1.5rem;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Error message */
.error-message {
  color: #ef4444;
  font-size: 0.875rem;
  margin-top: 0.25rem;
}

/* Success message */
.success-message {
  color: #10b981;
  font-size: 0.875rem;
  margin-top: 0.25rem;
}

/* Objetivo cumplido badge */
.objetivo-cumplido {
  background-color: #10b981;
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 0.375rem;
  font-size: 0.75rem;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  margin-left: 0.5rem;
}

/* Testimonial styles - Enhanced */
.testimonial-card {
  transition: all 0.3s ease;
  border: 1px solid #dbeafe;
}

.testimonial-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.testimonial-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #dbeafe;
}

.testimonial-rating {
  display: flex;
  color: #facc15;
}

.testimonial-badge {
  position: absolute;
  top: 0;
  right: 0;
  background: linear-gradient(135deg, #3b82f6, #8b5cf6);
  color: white;
  font-size: 0.6rem;
  padding: 0.2rem 0.5rem;
  border-radius: 0 0.5rem 0 0.5rem;
  font-weight: bold;
}

.testimonial-verified {
  display: inline-flex;
  align-items: center;
  font-size: 0.65rem;
  color: #10b981;
  margin-left: 0.5rem;
}

/* Responsive */
@media (min-width: 768px) {
  .md\:grid-cols-2 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .md\:flex-row {
    flex-direction: row;
  }

  .md\:items-center {
    align-items: center;
  }

  .md\:mb-0 {
    margin-bottom: 0;
  }

  .md\:text-5xl {
    font-size: 3rem;
    line-height: 1;
  }

  .md\:p-8 {
    padding: 2rem;
  }
}

/* Testimonial carousel */
.testimonial-carousel {
  overflow: hidden;
  position: relative;
}

.testimonial-carousel-inner {
  display: flex;
  transition: transform 0.5s ease;
}

.testimonial-carousel-item {
  flex: 0 0 100%;
}

.testimonial-carousel-controls {
  display: flex;
  justify-content: center;
  margin-top: 1rem;
}

.testimonial-carousel-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background-color: #e5e7eb;
  margin: 0 4px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.testimonial-carousel-dot.active {
  background-color: #3b82f6;
}

@media (min-width: 768px) {
  .testimonial-carousel-item {
    flex: 0 0 50%;
  }
}
</style>
</head>
<body>
  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black/30 backdrop-blur-sm">
    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full">
      <h2 class="text-2xl font-bold mb-4 text-blue-800">Iniciar SesiÃ³n</h2>
      <p class="text-gray-600 mb-6">Ingresa tus datos para acceder al sistema de referidos</p>
      
      <!-- Login Tabs -->
      <div class="mb-6">
        <div class="flex border-b border-gray-200">
          <button id="emailLoginTab" class="py-2 px-4 font-medium text-blue-600 border-b-2 border-blue-600">
            Email y ContraseÃ±a
          </button>
          <button id="codeLoginTab" class="py-2 px-4 font-medium text-gray-500 hover:text-blue-600">
            CÃ³digo Ãnico
          </button>
        </div>
      </div>
      
      <!-- Email Login Form -->
      <div id="emailLoginForm" class="space-y-4">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo electrÃ³nico</label>
          <input 
            id="email" 
            type="email" 
            class="input border-gray-300 w-full" 
            placeholder="tu@email.com"
          />
          <div id="emailError" class="error-message hidden"></div>
        </div>
        
        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-1">ContraseÃ±a</label>
          <input 
            id="password" 
            type="password" 
            class="input border-gray-300 w-full" 
            placeholder="â¢â¢â¢â¢â¢â¢â¢â¢"
          />
          <div id="passwordError" class="error-message hidden"></div>
        </div>
        
        <div id="loginError" class="error-message hidden bg-red-50 p-3 rounded-md"></div>
        
        <button 
          id="loginButton" 
          class="btn-primary w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 py-3"
        >
          <span id="loginButtonText">Iniciar SesiÃ³n</span>
          <span id="loginSpinner" class="loading-spinner ml-2 hidden"></span>
        </button>
      </div>
      
      <!-- Code Login Form -->
      <div id="codeLoginForm" class="space-y-4 hidden">
        <div>
          <label for="uniqueCode" class="block text-sm font-medium text-gray-700 mb-1">CÃ³digo Ãnico</label>
          <input 
            id="uniqueCode" 
            type="text" 
            class="input border-gray-300 w-full" 
            placeholder="Ingresa tu cÃ³digo Ãºnico"
          />
          <div id="codeError" class="error-message hidden"></div>
        </div>
        
        <div id="codeLoginError" class="error-message hidden bg-red-50 p-3 rounded-md"></div>
        
        <button 
          id="codeLoginButton" 
          class="btn-primary w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 py-3"
        >
          <span id="codeLoginButtonText">Iniciar SesiÃ³n con CÃ³digo</span>
          <span id="codeLoginSpinner" class="loading-spinner ml-2 hidden"></span>
        </button>
      </div>
      
      <div class="text-center mt-6">
        <button id="registerToggle" class="text-blue-600 text-sm hover:underline">
          Â¿No tienes cuenta? RegÃ­strate aquÃ­
        </button>
      </div>
    </div>
  </div>
  
  <!-- Register Modal -->
  <div id="registerModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black/30 backdrop-blur-sm hidden">
    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full">
      <h2 class="text-2xl font-bold mb-4 text-blue-800">Crear Cuenta</h2>
      <p class="text-gray-600 mb-6">RegÃ­strate para comenzar a usar el sistema de referidos</p>
      
      <div class="space-y-4">
        <div>
          <label for="registerName" class="block text-sm font-medium text-gray-700 mb-1">Nombre completo</label>
          <input 
            id="registerName" 
            type="text" 
            class="input border-gray-300 w-full" 
            placeholder="Tu nombre"
          />
          <div id="nameError" class="error-message hidden"></div>
        </div>
        
        <div>
          <label for="registerEmail" class="block text-sm font-medium text-gray-700 mb-1">Correo electrÃ³nico</label>
          <input 
            id="registerEmail" 
            type="email" 
            class="input border-gray-300 w-full" 
            placeholder="tu@email.com"
          />
          <div id="registerEmailError" class="error-message hidden"></div>
        </div>
        
        <div>
          <label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-1">ContraseÃ±a</label>
          <input 
            id="registerPassword" 
            type="password" 
            class="input border-gray-300 w-full" 
            placeholder="â¢â¢â¢â¢â¢â¢â¢â¢"
          />
          <div id="registerPasswordError" class="error-message hidden"></div>
        </div>
        
        <div>
          <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirmar contraseÃ±a</label>
          <input 
            id="confirmPassword" 
            type="password" 
            class="input border-gray-300 w-full" 
            placeholder="â¢â¢â¢â¢â¢â¢â¢â¢"
          />
          <div id="confirmPasswordError" class="error-message hidden"></div>
        </div>
        
        <div id="registerError" class="error-message hidden bg-red-50 p-3 rounded-md"></div>
        
        <button 
          id="registerButton" 
          class="btn-primary w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 py-3"
        >
          <span id="registerButtonText">Crear Cuenta</span>
          <span id="registerSpinner" class="loading-spinner ml-2 hidden"></span>
        </button>
        
        <div class="text-center">
          <button id="loginToggle" class="text-blue-600 text-sm hover:underline">
            Â¿Ya tienes cuenta? Inicia sesiÃ³n aquÃ­
          </button>
        </div>
      </div>
    </div>
  </div>

  <main class="min-h-screen bg-gradient-to-b from-blue-100 to-white p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-3xl md:text-5xl font-bold text-center bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">
          Sistema de Referidos
        </h1>
        <button id="logoutButton" class="btn-outline border-blue-300 text-blue-600 hover:bg-blue-50 hidden">
          <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Cerrar sesiÃ³n
        </button>
      </div>
      <p class="text-center text-blue-600 mb-8 max-w-xl mx-auto">
        Invita a tus amigos y familiares y desbloquea increÃ­bles bonificaciones exclusivas. Â¡Cuantos mÃ¡s referidos, mayores beneficios!
      </p>
      
      <!-- Celebration overlay -->
      <div id="celebrationOverlay" class="fixed inset-0 flex items-center justify-center z-50 bg-black/30 backdrop-blur-sm hidden">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-8 rounded-xl shadow-2xl text-white text-center max-w-md relative overflow-hidden celebration-modal">
          <!-- Animated background sparkles -->
          <div class="absolute inset-0 overflow-hidden sparkles-container">
            <!-- Sparkles will be added via JavaScript -->
          </div>
          
          <div class="relative z-10 party-popper-container">
            <div class="relative">
              <div class="absolute inset-0 blur-xl bg-yellow-400 rounded-full opacity-50 animate-pulse"></div>
              <svg class="h-20 w-20 mx-auto mb-4 text-yellow-300 relative z-10" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5.8 11.3 2 22l10.7-3.79"></path>
                <path d="M4 3h.01"></path>
                <path d="M22 8h.01"></path>
                <path d="M15 2h.01"></path>
                <path d="M22 20h.01"></path>
                <path d="m22 2-2.24.75a2.9 2.9 0 0 0-1.96 3.12v0c.1.86-.57 1.63-1.45 1.63h-.38c-.86 0-1.6.6-1.76 1.44L14 10"></path>
                <path d="m22 13-.82-.33c-.86-.34-1.82.2-1.98 1.11v0c-.11.7-.72 1.22-1.43 1.22H17"></path>
                <path d="m11 2 .33.82c.34.86-.2 1.82-1.11 1.98v0C9.52 4.9 9 5.52 9 6.23V7"></path>
                <path d="M11 13c1.93 1.93 2.83 4.17 2 5-.83.83-3.07-.07-5-2-1.93-1.93-2.83-4.17-2-5 .83-.83 3.07.07 5 2Z"></path>
              </svg>
            </div>
          </div>
          
          <h2 class="text-3xl font-bold mb-2 relative z-10 celebration-title">
            Â¡BONIFICACIÃN DESBLOQUEADA!
          </h2>
          
          <div class="relative z-10 celebration-content">
            <p class="text-2xl mb-4 font-bold bg-clip-text text-transparent bg-gradient-to-r from-yellow-300 to-white" id="celebrationMessage">
              Has ganado un TANQUE LLENO
            </p>
            
            <div class="mt-6 flex flex-col items-center">
              <button id="closeCelebration" class="bg-white text-blue-600 hover:bg-blue-50 font-bold text-lg px-8 py-6 rounded-full shadow-lg transform transition hover:scale-105">
                Â¡Genial!
              </button>
              
              <p class="mt-4 text-sm text-blue-100">
                Comparte esta bonificaciÃ³n con tus amigos
              </p>
              
              <div class="mt-2">
                <button id="shareCelebration" class="btn-ghost text-white hover:bg-white/20">
                  <svg class="mr-2 h-4 w-4 inline-block" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                  </svg>
                  Compartir
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tips popup -->
      <div id="tipsPopup" class="fixed bottom-4 right-4 max-w-xs bg-gradient-to-r from-amber-500 to-orange-500 p-4 rounded-lg shadow-lg text-white z-40 hidden">
        <div class="flex items-start">
          <svg class="h-5 w-5 mr-2 mt-0.5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
            <path d="M5 3v4"></path>
            <path d="M19 17v4"></path>
            <path d="M3 5h4"></path>
            <path d="M17 19h4"></path>
          </svg>
          <div>
            <h4 class="font-bold text-sm">Â¡Consejo Pro!</h4>
            <p class="text-xs mt-1" id="tipContent">
              Comparte tu enlace de referido en grupos de WhatsApp para conseguir mÃ¡s referidos rÃ¡pidamente.
            </p>
          </div>
          <button id="closeTip" class="ml-2 text-white/70 hover:text-white">
            Ã
          </button>
        </div>
      </div>
      
      <!-- Streak badge -->
      <div id="streakBadge" class="fixed top-4 right-4 bg-gradient-to-r from-red-500 to-orange-500 px-4 py-2 rounded-full shadow-lg text-white z-40 hidden">
        <svg class="h-5 w-5 mr-2 inline-block" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"></path>
        </svg>
        <div class="inline-block">
          <span class="font-bold" id="streakCount">2</span> dÃ­as de racha
        </div>
      </div>
      
      <!-- Limited time offer -->
      <div id="limitedTimeOffer" class="mb-6 bg-gradient-to-r from-red-500 to-orange-500 rounded-lg shadow-lg overflow-hidden hidden" style="display: none;">
        <div class="p-4 relative">
          <div class="absolute top-2 right-2">
            <button id="closeLimitedOffer" class="text-white/70 hover:text-white">
              Ã
            </button>
          </div>
          
          <div class="flex items-center">
            <div class="mr-4 bg-white/20 p-2 rounded-full">
              <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
            </div>
            <div>
              <h3 class="font-bold text-white text-lg">Â¡Oferta por tiempo limitado!</h3>
              <p class="text-white/90 text-sm">
                Agrega 3 referidos en los prÃ³ximos <span id="countdownTimer">30:00</span> y recibe un <span class="font-bold">BONO EXTRA</span>
              </p>
            </div>
          </div>
          
          <div class="mt-3 bg-white/20 h-1.5 rounded-full overflow-hidden">
            <div id="countdownProgress" class="bg-white h-full rounded-full" style="width: 100%"></div>
          </div>
        </div>
      </div>
      
      <!-- Dashboard header -->
      <div class="mb-6 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl shadow-lg overflow-hidden">
        <div class="p-6">
          <div class="flex flex-col md:flex-row md:items-center justify-between">
            <div class="mb-4 md:mb-0">
              <h2 class="text-xl font-bold text-white flex items-center">
                <svg class="mr-2 h-5 w-5 text-yellow-300" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
                </svg>
                Nivel <span id="userLevel">1</span>
              </h2>
              <p class="text-blue-100 text-sm">
                <span id="referralCount">0</span> referidos Â· <span id="totalPoints">0</span> puntos
              </p>
            </div>
            
            <div class="flex space-x-2">
              <div class="tooltip" style="display: none;">
                <button id="shareButton" class="btn-outline bg-white/10 text-white border-white/20 hover:bg-white/20">
                  <svg class="mr-2 h-4 w-4 inline-block" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                  </svg>
                  Compartir
                </button>
                <span class="tooltiptext">Comparte tu cÃ³digo de referido</span>
              </div>
              
              <div id="streakBadgeSmall" class="tooltip hidden">
                <span class="badge bg-white/10 text-white border-white/20 flex items-center">
                  <svg class="mr-1 h-3 w-3 text-yellow-300" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"></path>
                  </svg>
                  <span id="streakCountSmall">0</span> dÃ­as
                </span>
                <span class="tooltiptext">Â¡MantÃ©n tu racha diaria!</span>
              </div>
              
              <div id="topBadge" class="tooltip hidden">
                <span class="badge bg-white/10 text-white border-white/20 flex items-center">
                  <svg class="mr-1 h-3 w-3 text-yellow-300" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                    <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                    <path d="M4 22h16"></path>
                    <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
                    <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
                    <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
                  </svg>
                  Top <span id="topPercentage">10</span>%
                </span>
                <span class="tooltiptext">Â¡EstÃ¡s entre los mejores referidores!</span>
              </div>
            </div>
          </div>
          
          <!-- Next reward progress -->
          <div id="nextRewardContainer" class="mt-4 hidden">
            <div class="flex justify-between items-center mb-1">
              <div class="text-sm text-white flex items-center">
                <span>PrÃ³xima recompensa: </span>
                <span class="font-bold ml-1" id="nextRewardName">Tanque Lleno Gratis</span>
              </div>
              <span class="text-xs text-blue-100">
                <span id="currentReferrals">0</span>/<span id="requiredReferrals">2</span>
              </span>
            </div>
            
            <div class="h-2 bg-blue-900/50 rounded-full overflow-hidden">
              <div id="nextRewardProgress" class="h-full bg-gradient-to-r from-blue-300 to-purple-300" style="width: 0%"></div>
            </div>
            
            <p id="remainingReferralsText" class="text-xs text-blue-100 mt-1">
              Te faltan 2 referidos para desbloquear esta recompensa
            </p>
          </div>
        </div>
      </div>
      
      <!-- Main progress bar -->
      <div class="mb-8 bg-gradient-to-r from-blue-100 to-purple-100 p-6 rounded-xl shadow-md">
        <div class="flex justify-between items-center mb-2">
          <h3 class="font-bold text-blue-800">Tu progreso de bonificaciones</h3>
          <span class="text-sm font-medium text-blue-800"><span id="progressReferralCount">0</span>/10 referidos</span>
        </div>
        
        <div class="progress-container">
          <div id="mainProgress" class="progress-bar" style="width: 0%"></div>
        </div>
        
        <div class="flex justify-between mt-2 text-xs text-blue-700">
          <div class="flex flex-col items-center">
            <div id="milestone1" class="w-4 h-4 rounded-full mb-1 flex items-center justify-center bg-gray-300">
              <!-- CheckCircle icon will be added via JavaScript when milestone is reached -->
            </div>
            <span>2</span>
          </div>
          <div class="flex flex-col items-center">
            <div id="milestone2" class="w-4 h-4 rounded-full mb-1 flex items-center justify-center bg-gray-300">
              <!-- CheckCircle icon will be added via JavaScript when milestone is reached -->
            </div>
            <span>4</span>
          </div>
          <div class="flex flex-col items-center">
            <div id="milestone3" class="w-4 h-4 rounded-full mb-1 flex items-center justify-center bg-gray-300">
              <!-- CheckCircle icon will be added via JavaScript when milestone is reached -->
            </div>
            <span>10</span>
          </div>
        </div>
      </div>
      
      <!-- Tabs -->
      <div class="tabs-container">
        <div class="tabs-list">
          <button class="tab-trigger active" data-tab="add">
            <div class="relative">
              Agregar Referido
              <span id="pulseDot" class="pulse-dot hidden">
                <span class="ping"></span>
                <span class="dot"></span>
              </span>
            </div>
          </button>
          <button class="tab-trigger" data-tab="list">
            Mis Referidos (<span id="tabReferralCount">0</span>)
          </button>
          <button class="tab-trigger" data-tab="bonuses">
            Bonificaciones
          </button>
        </div>
        
        <!-- Add Referral Tab -->
        <div class="tab-content active" id="addTab">
          <div class="card border-2 border-blue-100 shadow-lg overflow-hidden">
            <div class="card-header bg-gradient-to-r from-blue-50 to-purple-50">
              <h3 class="card-title text-blue-800">
                <svg class="mr-2 h-5 w-5 text-blue-600 inline-block" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="16"></line>
                  <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
                Nuevo Referido
              </h3>
              <p class="card-description text-blue-600">
                Â¡Cada referido te acerca a increÃ­bles bonificaciones! Â¡No esperes mÃ¡s!
              </p>
            </div>
            <div class="card-content space-y-4 pt-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 animate-fade-in">
                <div class="space-y-2">
                  <label for="firstName" class="text-blue-700">Nombre</label>
                  <input 
                    id="firstName" 
                    type="text"
                    placeholder="Nombre" 
                    class="input border-blue-200 focus:border-blue-500 focus:ring-blue-500"
                  />
                  <div id="firstNameError" class="error-message hidden"></div>
                </div>
                <div class="space-y-2">
                  <label for="lastName" class="text-blue-700">Apellido</label>
                  <input 
                    id="lastName" 
                    type="text"
                    placeholder="Apellido" 
                    class="input border-blue-200 focus:border-blue-500 focus:ring-blue-500"
                  />
                  <div id="lastNameError" class="error-message hidden"></div>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 animate-fade-in-delay">
                <div class="space-y-2">
                  <label for="phoneNumber" class="text-blue-700">NÃºmero de TelÃ©fono</label>
                  <input 
                    id="phoneNumber" 
                    type="text"
                    placeholder="NÃºmero de telÃ©fono" 
                    class="input border-blue-200 focus:border-blue-500 focus:ring-blue-500"
                  />
                  <div id="phoneNumberError" class="error-message hidden"></div>
                </div>
                <div class="space-y-2">
                  <label for="relationship" class="text-blue-700">RelaciÃ³n</label>
                  <div class="select-wrapper">
                    <select 
                      id="relationship" 
                      class="select border-blue-200 focus:border-blue-500 focus:ring-blue-500"
                    >
                      <option value="" disabled selected>Selecciona una relaciÃ³n</option>
                      <option value="family">Familiar</option>
                      <option value="friend">Amigo</option>
                      <option value="colleague">Colega</option>
                      <option value="other">Otro</option>
                    </select>
                  </div>
                  <div id="relationshipError" class="error-message hidden"></div>
                </div>
              </div>
              
              <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg border border-blue-100 mt-4 animate-fade-in-scale">
                <h3 class="font-medium text-blue-800 flex items-center mb-2">
                  <svg class="mr-2 h-4 w-4 text-yellow-500 inline-block" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"></path>
                  </svg>
                  Â¿Por quÃ© agregar referidos?
                </h3>
                <ul class="space-y-2 text-sm text-blue-700">
                  <li class="flex items-start">
                    <svg class="mr-2 h-4 w-4 text-green-500 mt-0.5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                      <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <span>Con solo <strong>2 referidos</strong> obtienes un <strong class="text-green-600">TANQUE LLENO GRATIS</strong></span>
                  </li>
                  <li class="flex items-start">
                    <svg class="mr-2 h-4 w-4 text-green-500 mt-0.5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                      <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <span>Con <strong>4 referidos</strong> que compren su auto obtienes una <strong class="text-green-600">BONIFICACIÃN DE $200.000</strong></span>
                  </li>
                  <li class="flex items-start">
                    <svg class="mr-2 h-4 w-4 text-green-500 mt-0.5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                      <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <span>Con <strong>10 referidos</strong> obtienes una <strong class="text-green-600">TRANSFERENCIA BONIFICADA AL 100%</strong></span>
                  </li>
                </ul>
              </div>
              
              <!-- Testimonials - Enhanced Section -->
              <div class="mt-6 animate-fade-in-delay-long">
                <h4 class="text-sm font-medium text-blue-800 mb-3 flex items-center">
                  <svg class="mr-2 h-4 w-4 text-red-500 inline-block" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
                  </svg>
                  Lo que dicen nuestros usuarios
                </h4>
                
                <!-- Testimonial Carousel -->
                <div class="testimonial-carousel">
                  <div class="testimonial-carousel-inner" id="testimonialCarousel">
                    <!-- Testimonials will be added dynamically -->
                  </div>
                  <div class="testimonial-carousel-controls" id="testimonialCarouselControls">
                    <!-- Dots will be added dynamically -->
                  </div>
                </div>
              </div>
            </div>
            <div class="card-footer bg-gradient-to-r from-blue-50 to-purple-50 border-t border-blue-100">
              <button 
                id="addReferralButton" 
                class="btn-primary w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-medium py-6"
              >
                <div class="flex items-center justify-center hover-scale">
                  <svg class="mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                  </svg>
                  Agregar Referido y Ganar Bonificaciones
                </div>
              </button>
            </div>
          </div>
        </div>
        
        <!-- List Referrals Tab -->
        <div class="tab-content" id="listTab">
          <div class="card border-2 border-blue-100 shadow-lg">
            <div class="card-header bg-gradient-to-r from-blue-50 to-purple-50">
              <h3 class="card-title text-blue-800">
                <svg class="mr-2 h-5 w-5 text-blue-600 inline-block" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                Mis Referidos
              </h3>
              <p id="referralListDescription" class="card-description text-blue-600">
                Â¡Comienza a agregar referidos para obtener increÃ­bles bonificaciones!
              </p>
            </div>
            <div class="card-content">
              <div id="emptyReferralList" class="text-center py-12 text-gray-500">
                <svg class="mx-auto h-16 w-16 mb-4 text-blue-200" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <p class="text-lg mb-4">No has agregado ningÃºn referido aÃºn.</p>
                <button 
                  id="addFirstReferralButton"
                  class="btn-primary bg-blue-600 hover:bg-blue-700"
                >
                  Agregar mi primer referido
                </button>
              </div>
              
              <div id="referralListContent" class="hidden">
                <!-- Stats summary -->
                <div class="grid grid-cols-3 gap-2 mb-6">
                  <div class="bg-blue-50 p-3 rounded-lg text-center">
                    <p class="text-xs text-blue-600">Total Puntos</p>
                    <p id="statsTotalPoints" class="text-xl font-bold text-blue-800">0</p>
                  </div>
                  <div class="bg-blue-50 p-3 rounded-lg text-center">
                    <p class="text-xs text-blue-600">Nivel</p>
                    <p id="statsLevel" class="text-xl font-bold text-blue-800">1</p>
                  </div>
                  <div class="bg-blue-50 p-3 rounded-lg text-center">
                    <p class="text-xs text-blue-600">PosiciÃ³n</p>
                    <p id="statsPosition" class="text-xl font-bold text-blue-800">Top 10%</p>
                  </div>
                </div>
                
                <div id="referralsList" class="space-y-4">
                  <!-- Referrals will be added here via JavaScript -->
                </div>
              </div>
            </div>
            <div id="referralListFooter" class="card-footer bg-gradient-to-r from-blue-50 to-purple-50 border-t border-blue-100 flex justify-between hidden">
              <p id="remainingReferralsFooter" class="text-sm text-blue-600">
                Te faltan 10 referidos para desbloquear todas las bonificaciones
              </p>
              <button 
                id="addMoreReferralsButton"
                class="btn-primary bg-blue-600 hover:bg-blue-700"
              >
                Agregar mÃ¡s
              </button>
            </div>
          </div>
        </div>
        
        <!-- Bonuses Tab -->
        <div class="tab-content" id="bonusesTab">
          <div class="card border-2 border-blue-100 shadow-lg">
            <div class="card-header bg-gradient-to-r from-blue-50 to-purple-50">
              <h3 class="card-title text-blue-800">
                <svg class="mr-2 h-5 w-5 text-yellow-500 inline-block" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                  <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                  <path d="M4 22h16"></path>
                  <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
                  <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
                  <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
                </svg>
                Mis Bonificaciones
              </h3>
              <p class="card-description text-blue-600">
                Desbloquea increÃ­bles bonificaciones agregando referidos.
              </p>
            </div>
            <div class="card-content">
              <div class="space-y-6 py-2" id="rewardsList">
                <!-- Rewards will be added here via JavaScript -->
              </div>
            </div>
            <div class="card-footer bg-gradient-to-r from-blue-50 to-purple-50 border-t border-blue-100">
              <div class="w-full text-center">
                <div id="bonusesFooterIncomplete" class="space-y-2">
                  <p class="text-blue-700">Â¡No te pierdas estas increÃ­bles bonificaciones!</p>
                  <button 
                    id="addMoreForBonusesButton"
                    class="btn-primary bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700"
                  >
                    Seguir agregando referidos
                  </button>
                </div>
                <div id="bonusesFooterComplete" class="p-2 bg-green-100 rounded-lg text-green-800 hidden">
                  <svg class="inline-block mr-2 h-5 w-5 text-green-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5.8 11.3 2 22l10.7-3.79"></path>
                    <path d="M4 3h.01"></path>
                    <path d="M22 8h.01"></path>
                    <path d="M15 2h.01"></path>
                    <path d="M22 20h.01"></path>
                    <path d="m22 2-2.24.75a2.9 2.9 0 0 0-1.96 3.12v0c.1.86-.57 1.63-1.45 1.63h-.38c-.86 0-1.6.6-1.76 1.44L14 10"></path>
                    <path d="m22 13-.82-.33c-.86-.34-1.82.2-1.98 1.11v0c-.11.7-.72 1.22-1.43 1.22H17"></path>
                    <path d="m11 2 .33.82c.34.86-.2 1.82-1.11 1.98v0C9.52 4.9 9 5.52 9 6.23V7"></path>
                    <path d="M11 13c1.93 1.93 2.83 4.17 2 5-.83.83-3.07-.07-5-2-1.93-1.93-2.83-4.17-2-5 .83-.83 3.07.07 5 2Z"></path>
                  </svg>
                  Â¡Felicidades! Has desbloqueado todas las bonificaciones disponibles
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Share drawer -->
      <div id="shareDrawer" class="drawer hidden">
        <div class="drawer-overlay"></div>
        <div class="drawer-content">
          <div class="mx-auto w-full max-w-sm">
            <div class="drawer-header">
              <h3 class="drawer-title">Comparte tu cÃ³digo de referido</h3>
              <p class="drawer-description">
                Invita a tus amigos y familiares para ganar bonificaciones juntos
              </p>
            </div>
            <div class="p-4 pb-8">
              <div class="bg-blue-50 p-4 rounded-lg text-center mb-4">
                <p class="text-sm text-blue-600 mb-2">Tu cÃ³digo Ãºnico</p>
                <p id="referralCode" class="text-2xl font-bold text-blue-800 tracking-wider">ABC123</p>
              </div>
              
              <div class="space-y-2">
                <button 
                  id="shareReferralLinkButton" 
                  class="btn-primary w-full flex items-center justify-center"
                >
                  <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                  </svg>
                  Compartir enlace
                </button>
                
                <p class="text-xs text-center text-gray-500 mt-4">
                  Comparte este cÃ³digo con tus amigos y familiares. Cuando se registren usando tu cÃ³digo, ambos recibirÃ¡n beneficios exclusivos.
                </p>
              </div>
            </div>
            <button id="closeShareDrawer" class="drawer-close">Ã</button>
          </div>
        </div>
      </div>
      
      <!-- Toast container -->
      <div id="toastContainer" class="toast-container"></div>
    </div>
  </main>

  <script>
    // Initialize Supabase client
    window.supabase = supabase.createClient(
      'https://chfvphikhfjwgjbjyzzy.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoZnZwaGlraGZqd2dqYmp5enp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIzNDA5MjEsImV4cCI6MjA1NzkxNjkyMX0.KmQWXTlrDMicgaP_Jcibypxia2sVkj6zH9XwTqh1bx4'
    );
    
    document.addEventListener('DOMContentLoaded', () => {
      // State
      let currentUser = null;
      const referrals = [];
      let firstName = '';
      let lastName = '';
      let phoneNumber = '';
      let relationship = '';
      let activeTab = 'add';
      let progress = 0;
      let showCelebration = false;
      let recentBonus = null;
      let totalPoints = 0;
      let level = 1;
      let showTips = false;
      let showShareDrawer = false;
      let countdown = null;
      let showLimitedTimeOffer = false;
      const showPulse = false;
      let streak = 0;
      let lastReferralDate = null;
      let currentTestimonialSlide = 0;
      
      // Rewards data with proper UUIDs
      const rewards = [
        {
          id: "f47ac10b-58cc-4372-a567-0e02b2c3d479", // UUID for tanque
          name: "Tanque Lleno Gratis",
          description: "Ahorra en combustible con un tanque completamente lleno.",
          icon: "gift",
          requiredReferrals: 2,
          claimed: false,
          type: "tanque" // Keep type for reference
        },
        {
          id: "550e8400-e29b-41d4-a716-446655440000", // UUID for cuota
          name: "BonificaciÃ³n de $200.000",
          description: "Una BonificaciÃ³n de $200.000 para ti.",
          icon: "star",
          requiredReferrals: 4,
          claimed: false,
          type: "cuota", // Keep type for reference
          requiresStatus: "compro_auto" // Requiere que 4 referidos hayan comprado auto
        },
        {
          id: "6ba7b810-9dad-11d1-80b4-00c04fd430c8", // UUID for transferencia
          name: "Transferencia Bonificada al 100%",
          description: "Transferencia completamente gratis para ti.",
          icon: "trophy",
          requiredReferrals: 10,
          claimed: false,
          type: "transferencia" // Keep type for reference
        }
      ];
      
      // Testimonial data with profile photos
      const testimonials = [
        {
          name: "MarÃ­a G.",
          initials: "MG",
          photo: "https://randomuser.me/api/portraits/women/32.jpg",
          rating: 5,
          text: "Â¡IncreÃ­ble! ConseguÃ­ mi tanque lleno gratis en solo 2 dÃ­as invitando a mis familiares.",
          date: "Hace 3 dÃ­as",
          verified: true
        },
        {
          name: "Juan R.",
          initials: "JR",
          photo: "https://randomuser.me/api/portraits/men/45.jpg",
          rating: 5,
          text: "Ya llevo 8 referidos y casi consigo la transferencia bonificada. Â¡El sistema es sÃºper fÃ¡cil!",
          date: "Hace 1 semana",
          verified: true
        },
        {
          name: "Ana L.",
          initials: "AL",
          photo: "https://randomuser.me/api/portraits/women/68.jpg",
          rating: 5,
          text: "CompartÃ­ mi cÃ³digo con mis compaÃ±eros de trabajo y en menos de una semana ya tenÃ­a 5 referidos.",
          date: "Hace 2 dÃ­as",
          verified: true
        },
        {
          name: "Carlos M.",
          initials: "CM",
          photo: "https://randomuser.me/api/portraits/men/22.jpg",
          rating: 4,
          text: "Muy buena experiencia. La bonificaciÃ³n de la cuota me vino genial para mi presupuesto mensual.",
          date: "Hace 5 dÃ­as",
          verified: true
        },
        {
          name: "Laura P.",
          initials: "LP",
          photo: "https://randomuser.me/api/portraits/women/90.jpg",
          rating: 5,
          text: "Â¡Excelente sistema! ConseguÃ­ todos mis referidos compartiendo en grupos de WhatsApp de la familia.",
          date: "Hace 1 dÃ­a",
          verified: true
        },
        {
          name: "Roberto S.",
          initials: "RS",
          photo: "https://randomuser.me/api/portraits/men/36.jpg",
          rating: 5,
          text: "Nunca pensÃ© que serÃ­a tan fÃ¡cil conseguir bonificaciones. Â¡Ya voy por mi segunda transferencia!",
          date: "Hace 4 dÃ­as",
          verified: true
        }
      ];
  
      // Add function to ensure rewards exist in database
      async function ensureRewardsExist() {
        if (!currentUser) return;
        
        try {
          // First check if rewards already exist
          const { data: existingRewards, error: checkError } = await supabase
            .from('rewards')
            .select('id');
          
          if (checkError) {
            console.error('Error checking rewards:', checkError);
            return;
          }
          
          // Create a map of existing reward IDs for quick lookup
          const existingRewardIds = new Set(existingRewards.map(r => r.id));
          
          // Filter rewards that don't exist in the database
          const rewardsToCreate = rewards.filter(r => !existingRewardIds.has(r.id));
          
          if (rewardsToCreate.length > 0) {
            // Format rewards for insertion
            const rewardsData = rewardsToCreate.map(r => ({
              id: r.id,
              name: r.name,
              description: r.description,
              icon: r.icon,
              required_referrals: r.requiredReferrals,
              is_active: true
            }));
            
            // Insert missing rewards
            const { error: insertError } = await supabase
              .from('rewards')
              .insert(rewardsData);
            
            if (insertError) {
              console.error('Error creating rewards:', insertError);
            } else {
              console.log('Created missing rewards:', rewardsToCreate.length);
            }
          }
        } catch (error) {
          console.error('Error ensuring rewards exist:', error);
        }
      }
      
      // DOM Elements
      const elements = {
        // Auth elements
        loginModal: document.getElementById('loginModal'),
        registerModal: document.getElementById('registerModal'),
        loginButton: document.getElementById('loginButton'),
        registerButton: document.getElementById('registerButton'),
        loginToggle: document.getElementById('loginToggle'),
        registerToggle: document.getElementById('registerToggle'),
        email: document.getElementById('email'),
        password: document.getElementById('password'),
        registerName: document.getElementById('registerName'),
        registerEmail: document.getElementById('registerEmail'),
        registerPassword: document.getElementById('registerPassword'),
        confirmPassword: document.getElementById('confirmPassword'),
        loginError: document.getElementById('loginError'),
        registerError: document.getElementById('registerError'),
        loginSpinner: document.getElementById('loginSpinner'),
        registerSpinner: document.getElementById('registerSpinner'),
        loginButtonText: document.getElementById('loginButtonText'),
        registerButtonText: document.getElementById('registerButtonText'),
        logoutButton: document.getElementById('logoutButton'),
        
        // Code login elements
        emailLoginTab: document.getElementById('emailLoginTab'),
        codeLoginTab: document.getElementById('codeLoginTab'),
        emailLoginForm: document.getElementById('emailLoginForm'),
        codeLoginForm: document.getElementById('codeLoginForm'),
        uniqueCode: document.getElementById('uniqueCode'),
        codeError: document.getElementById('codeError'),
        codeLoginError: document.getElementById('codeLoginError'),
        codeLoginButton: document.getElementById('codeLoginButton'),
        codeLoginSpinner: document.getElementById('codeLoginSpinner'),
        codeLoginButtonText: document.getElementById('codeLoginButtonText'),
        
        // Tabs
        tabTriggers: document.querySelectorAll('.tab-trigger'),
        tabContents: document.querySelectorAll('.tab-content'),
        
        // Form inputs
        firstNameInput: document.getElementById('firstName'),
        lastNameInput: document.getElementById('lastName'),
        phoneNumberInput: document.getElementById('phoneNumber'),
        relationshipSelect: document.getElementById('relationship'),
        addReferralButton: document.getElementById('addReferralButton'),
        firstNameError: document.getElementById('firstNameError'),
        lastNameError: document.getElementById('lastNameError'),
        phoneNumberError: document.getElementById('phoneNumberError'),
        relationshipError: document.getElementById('relationshipError'),
        
        // Referral list
        referralCount: document.getElementById('referralCount'),
        tabReferralCount: document.getElementById('tabReferralCount'),
        progressReferralCount: document.getElementById('progressReferralCount'),
        emptyReferralList: document.getElementById('emptyReferralList'),
        referralListContent: document.getElementById('referralListContent'),
        referralsList: document.getElementById('referralsList'),
        referralListDescription: document.getElementById('referralListDescription'),
        referralListFooter: document.getElementById('referralListFooter'),
        remainingReferralsFooter: document.getElementById('remainingReferralsFooter'),
        
        // Progress
        mainProgress: document.getElementById('mainProgress'),
        milestone1: document.getElementById('milestone1'),
        milestone2: document.getElementById('milestone2'),
        milestone3: document.getElementById('milestone3'),
        
        // Dashboard
        userLevel: document.getElementById('userLevel'),
        totalPoints: document.getElementById('totalPoints'),
        nextRewardContainer: document.getElementById('nextRewardContainer'),
        nextRewardName: document.getElementById('nextRewardName'),
        currentReferrals: document.getElementById('currentReferrals'),
        requiredReferrals: document.getElementById('requiredReferrals'),
        nextRewardProgress: document.getElementById('nextRewardProgress'),
        remainingReferralsText: document.getElementById('remainingReferralsText'),
        
        // Stats
        statsTotalPoints: document.getElementById('statsTotalPoints'),
        statsLevel: document.getElementById('statsLevel'),
        statsPosition: document.getElementById('statsPosition'),
        
        // Bonuses
        rewardsList: document.getElementById('rewardsList'),
        bonusesFooterIncomplete: document.getElementById('bonusesFooterIncomplete'),
        bonusesFooterComplete: document.getElementById('bonusesFooterComplete'),
        
        // Celebration
        celebrationOverlay: document.getElementById('celebrationOverlay'),
        celebrationMessage: document.getElementById('celebrationMessage'),
        closeCelebration: document.getElementById('closeCelebration'),
        
        // Tips
        tipsPopup: document.getElementById('tipsPopup'),
        tipContent: document.getElementById('tipContent'),
        closeTip: document.getElementById('closeTip'),
        
        // Streak
        streakBadge: document.getElementById('streakBadge'),
        streakCount: document.getElementById('streakCount'),
        streakBadgeSmall: document.getElementById('streakBadgeSmall'),
        streakCountSmall: document.getElementById('streakCountSmall'),
        
        // Limited time offer
        limitedTimeOffer: document.getElementById('limitedTimeOffer'),
        countdownTimer: document.getElementById('countdownTimer'),
        countdownProgress: document.getElementById('countdownProgress'),
        closeLimitedOffer: document.getElementById('closeLimitedOffer'),
        
        // Pulse
        pulseDot: document.getElementById('pulseDot'),
        
        // Top badge
        topBadge: document.getElementById('topBadge'),
        topPercentage: document.getElementById('topPercentage'),
        
        // Share
        shareButton: document.getElementById('shareButton'),
        shareDrawer: document.getElementById('shareDrawer'),
        closeShareDrawer: document.getElementById('closeShareDrawer'),
        shareReferralLinkButton: document.getElementById('shareReferralLinkButton'),
        shareCelebration: document.getElementById('shareCelebration'),
        referralCode: document.getElementById('referralCode'),
        
        // Navigation buttons
        addFirstReferralButton: document.getElementById('addFirstReferralButton'),
        addMoreReferralsButton: document.getElementById('addMoreReferralsButton'),
        addMoreForBonusesButton: document.getElementById('addMoreForBonusesButton'),
        
        // Testimonials
        testimonialCarousel: document.getElementById('testimonialCarousel'),
        testimonialCarouselControls: document.getElementById('testimonialCarouselControls'),
        
        // Toast
        toastContainer: document.getElementById('toastContainer')
      };
      
      // Initialize
      init();
      
      async function init() {
        // Check if user is logged in with code
        const codeLoginFlag = localStorage.getItem('referralSystemCodeLogin');
        const storedUser = localStorage.getItem('referralSystemUser');
        
        if (codeLoginFlag === 'true' && storedUser) {
          // User is logged in with code
          currentUser = JSON.parse(storedUser);
          
          // Update UI
          elements.loginModal.classList.add('hidden');
          elements.registerModal.classList.add('hidden');
          elements.logoutButton.classList.remove('hidden');
          
          // Set access code
          elements.referralCode.textContent = currentUser.accessCode;
          
          // Load user's referrals
          await loadReferrals();
          
          // Update UI
          updateReferralsList();
          updateProgress();
          updateLevel();
          updateRewardsList();
          updateNextReward();
          
          // Ensure rewards exist in database
          await ensureRewardsExist();
        } else {
          // Check if user is already logged in with Supabase Auth
          const { data: { session } } = await supabase.auth.getSession();
          if (session) {
            await handleSuccessfulLogin(session);
            
            // Ensure rewards exist in database
            await ensureRewardsExist();
          }
        }
        
        // Set up event listeners
        setupEventListeners();
        
        // Initialize testimonials carousel
        initTestimonialsCarousel();
        
        // Initialize limited time offer
        setTimeout(() => {
          if (currentUser) {
            showLimitedTimeOffer = true;
            countdown = 1800; // 30 minutos en segundos
            updateLimitedTimeOffer();
          }
        }, 5000);
        
        // Initialize pulse animation
        setupPulseAnimation();
        
        // Create sparkles for celebration
        createSparkles();
        
        // Initialize rewards
        updateRewardsList();
        
        // Update next reward
        updateNextReward();
        
        // Check if we need to reset monthly objectives
        checkMonthlyReset();
      }
      
      function setupEventListeners() {
        // Auth event listeners
        elements.loginButton.addEventListener('click', handleLogin);
        elements.registerButton.addEventListener('click', handleRegister);
        elements.loginToggle.addEventListener('click', () => {
          elements.registerModal.classList.add('hidden');
          elements.loginModal.classList.remove('hidden');
        });
        elements.registerToggle.addEventListener('click', () => {
          elements.loginModal.classList.add('hidden');
          elements.registerModal.classList.remove('hidden');
        });
        
        // Code login tab switching
        elements.emailLoginTab.addEventListener('click', () => {
          elements.emailLoginTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
          elements.emailLoginTab.classList.remove('text-gray-500');
          elements.codeLoginTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
          elements.codeLoginTab.classList.add('text-gray-500');
          elements.emailLoginForm.classList.remove('hidden');
          elements.codeLoginForm.classList.add('hidden');
        });
        
        elements.codeLoginTab.addEventListener('click', () => {
          elements.codeLoginTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
          elements.codeLoginTab.classList.remove('text-gray-500');
          elements.emailLoginTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
          elements.emailLoginTab.classList.add('text-gray-500');
          elements.codeLoginForm.classList.remove('hidden');
          elements.emailLoginForm.classList.add('hidden');
        });
        
        // Code login button
        elements.codeLoginButton.addEventListener('click', handleCodeLogin);
        
        // Logout button
        elements.logoutButton.addEventListener('click', handleLogout);
        
        // Tab switching
        elements.tabTriggers.forEach(trigger => {
          trigger.addEventListener('click', () => {
            const tab = trigger.getAttribute('data-tab');
            switchTab(tab);
          });
        });
        
        // Form inputs
        elements.firstNameInput.addEventListener('input', (e) => firstName = e.target.value);
        elements.lastNameInput.addEventListener('input', (e) => lastName = e.target.value);
        elements.phoneNumberInput.addEventListener('input', (e) => phoneNumber = e.target.value);
        elements.relationshipSelect.addEventListener('change', (e) => relationship = e.target.value);
        
        // Add referral
        elements.addReferralButton.addEventListener('click', addReferral);
        
        // Navigation buttons
        elements.addFirstReferralButton.addEventListener('click', () => switchTab('add'));
        elements.addMoreReferralsButton.addEventListener('click', () => switchTab('add'));
        elements.addMoreForBonusesButton.addEventListener('click', () => switchTab('add'));
        
        // Celebration
        elements.closeCelebration.addEventListener('click', () => {
          elements.celebrationOverlay.classList.add('hidden');
          showCelebration = false;
        });
        
        // Tips
        elements.closeTip.addEventListener('click', () => {
          elements.tipsPopup.classList.add('hidden');
          showTips = false;
        });
        
        // Limited time offer
        elements.closeLimitedOffer.addEventListener('click', () => {
          elements.limitedTimeOffer.classList.add('hidden');
          showLimitedTimeOffer = false;
        });
        
        // Share
        elements.shareButton.addEventListener('click', () => {
          elements.shareDrawer.classList.remove('hidden');
          showShareDrawer = true;
        });
        
        elements.closeShareDrawer.addEventListener('click', () => {
          elements.shareDrawer.classList.add('hidden');
          showShareDrawer = false;
        });
        
        elements.shareReferralLinkButton.addEventListener('click', shareReferralLink);
        elements.shareCelebration.addEventListener('click', shareReferralLink);
      }
      
      function initTestimonialsCarousel() {
        // Clear existing content
        elements.testimonialCarousel.innerHTML = '';
        elements.testimonialCarouselControls.innerHTML = '';
        
        // Calculate how many testimonials to show per slide based on screen width
        const isMobile = window.innerWidth < 768;
        const testimonialsPerSlide = isMobile ? 1 : 2;
        const totalSlides = Math.ceil(testimonials.length / testimonialsPerSlide);
        
        // Create slides
        for (let i = 0; i < totalSlides; i++) {
          const slideDiv = document.createElement('div');
          slideDiv.className = 'testimonial-carousel-item p-2';
          
          // Create testimonial cards for this slide
          const startIdx = i * testimonialsPerSlide;
          const endIdx = Math.min(startIdx + testimonialsPerSlide, testimonials.length);
          
          const slideContent = document.createElement('div');
          slideContent.className = 'grid grid-cols-1 md:grid-cols-2 gap-3';
          
          for (let j = startIdx; j < endIdx; j++) {
            const testimonial = testimonials[j];
            const testimonialCard = createTestimonialCard(testimonial);
            slideContent.appendChild(testimonialCard);
          }
          
          slideDiv.appendChild(slideContent);
          elements.testimonialCarousel.appendChild(slideDiv);
          
          // Create dot for this slide
          const dot = document.createElement('div');
          dot.className = `testimonial-carousel-dot ${i === 0 ? 'active' : ''}`;
          dot.setAttribute('data-slide', i);
          dot.addEventListener('click', () => {
            goToSlide(i);
          });
          elements.testimonialCarouselControls.appendChild(dot);
        }
        
        // Set initial position
        updateCarouselPosition();
        
        // Auto-rotate testimonials every 5 seconds
        setInterval(() => {
          if (!document.hidden) {
            nextSlide();
          }
        }, 5000);
      }
      
      function createTestimonialCard(testimonial) {
        const card = document.createElement('div');
        card.className = 'testimonial-card bg-white p-3 rounded-lg shadow-sm relative';
        
        // Add verified badge if applicable
        if (testimonial.verified) {
          const badge = document.createElement('div');
          badge.className = 'testimonial-badge';
          badge.textContent = 'Verificado';
          card.appendChild(badge);
        }
        
        // Create card content
        card.innerHTML += `
          <div class="flex items-center mb-2">
            <div class="mr-2">
              <img src="${testimonial.photo}" alt="${testimonial.name}" class="testimonial-avatar" 
                   onerror="this.onerror=null; this.innerHTML='${testimonial.initials}'; this.classList.add('avatar-fallback');">
            </div>
            <div>
              <p class="text-sm font-medium">${testimonial.name}</p>
              <div class="flex items-center">
                <div class="testimonial-rating">
                  ${Array(testimonial.rating).fill().map(() => 
                    `<svg class="h-3 w-3 fill-current" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>`
                  ).join('')}
                </div>
                ${testimonial.verified ? 
                  `<span class="testimonial-verified">
                    <svg class="h-3 w-3 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                      <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    Verificado
                  </span>` : 
                  ''}
              </div>
            </div>
          </div>
          <p class="text-xs text-gray-600">"${testimonial.text}"</p>
          <p class="text-xs text-gray-400 mt-2">${testimonial.date}</p>
        `;
        
        return card;
      }
      
      function updateCarouselPosition() {
        const translateX = -currentTestimonialSlide * 100;
        elements.testimonialCarousel.style.transform = `translateX(${translateX}%)`;
        
        // Update active dot
        const dots = elements.testimonialCarouselControls.querySelectorAll('.testimonial-carousel-dot');
        dots.forEach((dot, index) => {
          if (index === currentTestimonialSlide) {
            dot.classList.add('active');
          } else {
            dot.classList.remove('active');
          }
        });
      }
      
      function goToSlide(slideIndex) {
        const totalSlides = elements.testimonialCarouselControls.querySelectorAll('.testimonial-carousel-dot').length;
        currentTestimonialSlide = slideIndex;
        
        // Handle edge cases
        if (currentTestimonialSlide < 0) {
          currentTestimonialSlide = totalSlides - 1;
        } else if (currentTestimonialSlide >= totalSlides) {
          currentTestimonialSlide = 0;
        }
        
        updateCarouselPosition();
      }
      
      function nextSlide() {
        goToSlide(currentTestimonialSlide + 1);
      }
      
      function prevSlide() {
        goToSlide(currentTestimonialSlide - 1);
      }
      
      async function handleLogin(e) {
        e.preventDefault();
  
        // Resetear errores
        elements.loginError.classList.add('hidden');
        elements.loginError.textContent = '';
  
        // Obtener valores del formulario
        const email = elements.email.value.trim();
        const password = elements.password.value;
  
        // Validar el formulario
        if (!email || !password) {
            elements.loginError.textContent = 'Por favor completa todos los campos';
            elements.loginError.classList.remove('hidden');
            return;
        }
  
        // Mostrar estado de carga
        elements.loginSpinner.classList.remove('hidden');
        elements.loginButtonText.textContent = 'Iniciando sesiÃ³n...';
        elements.loginButton.disabled = true;
  
        try {
            // Iniciar sesiÃ³n con Supabase
            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password
            });
  
            // Manejar errores
            if (error) {
                if (error.message.includes('Email not confirmed')) {
                    elements.loginError.textContent = 'Tu correo no estÃ¡ confirmado. Por favor revisa tu bandeja de entrada para confirmarlo.';
                } else {
                    elements.loginError.textContent = error.message || 'Error al iniciar sesiÃ³n. IntÃ©ntalo de nuevo.';
                }
                elements.loginError.classList.remove('hidden');
                throw error;
            }
  
            // Manejar inicio de sesiÃ³n exitoso
            await handleSuccessfulLogin(data.session);
        } catch (error) {
            console.error('Error logging in:', error);
        } finally {
            // Restablecer estado de carga
            elements.loginSpinner.classList.add('hidden');
            elements.loginButtonText.textContent = 'Iniciar SesiÃ³n';
            elements.loginButton.disabled = false;
        }
      }
      
      async function handleRegister(e) {
        e.preventDefault();
        
        // Reset errors
        elements.registerError.classList.add('hidden');
        elements.registerError.textContent = '';
        
        // Get form values
        const name = elements.registerName.value.trim();
        const email = elements.registerEmail.value.trim();
        const password = elements.registerPassword.value;
        const confirmPassword = elements.confirmPassword.value;
        
        // Validate form
        if (!name || !email || !password || !confirmPassword) {
          elements.registerError.textContent = 'Por favor completa todos los campos';
          elements.registerError.classList.remove('hidden');
          return;
        }
        
        if (password !== confirmPassword) {
          elements.registerError.textContent = 'Las contraseÃ±as no coinciden';
          elements.registerError.classList.remove('hidden');
          return;
        }
        
        // Show loading state
        elements.registerSpinner.classList.remove('hidden');
        elements.registerButtonText.textContent = 'Creando cuenta...';
        elements.registerButton.disabled = true;
        
        try {
          // Sign up with Supabase
          const { data, error } = await supabase.auth.signUp({
            email,
            password,
            options: {
              data: {
                name
              }
            }
          });
          
          if (error) throw error;
          
          // Generate a unique access code
          const accessCode = generateUniqueCode();
          
          // Create user record in database
          const { error: userError } = await supabase
            .from('users')
            .insert([
              { 
                id: data.user.id,
                email: email,
                name: name,
                total_points: 0,
                level: 1,
                streak: 0,
                access_code: accessCode,
                last_referral_date: new Date().toISOString()
              }
            ]);
          
          if (userError) throw userError;
          
          await handleSuccessfulLogin(data.session);
          
          // Show success message
          showToast('Â¡Cuenta creada con Ã©xito!', 'Bienvenido al sistema de referidos', 'success');
        } catch (error) {
          console.error('Error registering:', error);
          elements.registerError.textContent = error.message || 'Error al crear la cuenta. IntÃ©ntalo de nuevo.';
          elements.registerError.classList.remove('hidden');
        } finally {
          // Reset loading state
          elements.registerSpinner.classList.add('hidden');
          elements.registerButtonText.textContent = 'Crear Cuenta';
          elements.registerButton.disabled = false;
        }
      }
      
      function generateUniqueCode() {
        // Generate a random 6-character alphanumeric code
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let code = '';
        for (let i = 0; i < 6; i++) {
          code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
      }
      
      async function handleLogout() {
        try {
          const { error } = await supabase.auth.signOut();
          if (error) throw error;
          
          // Clear localStorage
          localStorage.removeItem('referralSystemCodeLogin');
          localStorage.removeItem('referralSystemUser');
          
          // Reset state
          currentUser = null;
          referrals.length = 0;
          
          // Show login modal
          elements.loginModal.classList.remove('hidden');
          
          // Hide logout button
          elements.logoutButton.classList.add('hidden');
          
          // Reset UI
          updateReferralsList();
          updateProgress();
          updateLevel();
          updateRewardsList();
          updateNextReward();
          
          showToast('SesiÃ³n cerrada', 'Has cerrado sesiÃ³n correctamente', 'success');
        } catch (error) {
          console.error('Error logging out:', error);
          showToast('Error', 'No se pudo cerrar la sesiÃ³n', 'error');
        }
      }
      
      async function handleSuccessfulLogin(session) {
        // Hide login/register modals
        elements.loginModal.classList.add('hidden');
        elements.registerModal.classList.add('hidden');
        
        // Show logout button
        elements.logoutButton.classList.remove('hidden');
        
        // Get user data
        const { data: userData, error: userError } = await supabase
          .from('users')
          .select('*')
          .eq('id', session.user.id)
          .single();
        
        if (userError) {
          console.error('Error fetching user data:', userError);
          return;
        }
        
        // Set current user
        currentUser = {
          id: session.user.id,
          email: session.user.email,
          name: userData.name,
          totalPoints: userData.total_points,
          level: userData.level,
          streak: userData.streak,
          lastReferralDate: userData.last_referral_date,
          lastResetDate: userData.last_reset_date,
          accessCode: userData.access_code || generateUniqueCode()
        };
        
        // Set access code
        elements.referralCode.textContent = currentUser.accessCode;
        
        // Ensure rewards exist in database
        await ensureRewardsExist();
        
        // Load user's referrals
        await loadReferrals();
        
        // Update UI
        updateReferralsList();
        updateProgress();
        updateLevel();
        updateRewardsList();
        updateNextReward();
      }
      
      async function loadReferrals() {
        if (!currentUser) return;
        
        try {
          const { data, error } = await supabase
            .from('referrals')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          
          // Clear existing referrals
          referrals.length = 0;
          
          // Add loaded referrals
          data.forEach(ref => {
            referrals.push({
              id: ref.id,
              firstName: ref.first_name,
              lastName: ref.last_name,
              phoneNumber: ref.phone_number,
              relationship: ref.relationship,
              date: new Date(ref.created_at),
              points: ref.points,
              status: ref.status || 'pendiente' // Default to 'pendiente' if no status
            });
          });
          
          // Load user rewards
          await loadUserRewards();
        } catch (error) {
          console.error('Error loading referrals:', error);
          showToast('Error', 'No se pudieron cargar los referidos', 'error');
        }
      }
      
      async function loadUserRewards() {
        if (!currentUser) return;
        
        try {
          const { data, error } = await supabase
            .from('user_rewards')
            .select('reward_id')
            .eq('user_id', currentUser.id);
          
          if (error) throw error;
          
          // Mark claimed rewards
          data.forEach(userReward => {
            const reward = rewards.find(r => r.id === userReward.reward_id);
            if (reward) {
              reward.claimed = true;
            }
          });
        } catch (error) {
          console.error('Error loading user rewards:', error);
        }
      }
      
      async function checkMonthlyReset() {
        if (!currentUser || !currentUser.lastResetDate) return;
        
        const lastReset = new Date(currentUser.lastResetDate);
        const now = new Date();
        
        // Check if we're in a new month compared to the last reset
        if (lastReset.getMonth() !== now.getMonth() || lastReset.getFullYear() !== now.getFullYear()) {
          try {
            // Reset objectives by updating the last_reset_date
            const { error } = await supabase
              .from('users')
              .update({ last_reset_date: now.toISOString() })
              .eq('id', currentUser.id);
            
            if (error) throw error;
            
            // Reset rewards claimed status
            rewards.forEach(reward => {
              reward.claimed = false;
            });
            
            // Update UI
            updateRewardsList();
            updateNextReward();
            
            // Notify user
            showToast('Objetivos Reiniciados', 'Tus objetivos mensuales han sido reiniciados. Â¡Comienza a referir nuevamente!', 'special');
            
          } catch (error) {
            console.error('Error resetting monthly objectives:', error);
          }
        }
      }
      
      function switchTab(tab) {
        activeTab = tab;
        
        // Update tab triggers
        elements.tabTriggers.forEach(trigger => {
          if (trigger.getAttribute('data-tab') === tab) {
            trigger.classList.add('active');
          } else {
            trigger.classList.remove('active');
          }
        });
        
        // Update tab contents
        elements.tabContents.forEach(content => {
          if (content.id === `${tab}Tab`) {
            content.classList.add('active');
          } else {
            content.classList.remove('active');
          }
        });
      }
      
      async function addReferral() {
        if (!currentUser) {
          showToast('Error', 'Debes iniciar sesiÃ³n para agregar referidos', 'error');
          return;
        }
        
        // Reset error messages
        elements.firstNameError.classList.add('hidden');
        elements.lastNameError.classList.add('hidden');
        elements.phoneNumberError.classList.add('hidden');
        elements.relationshipError.classList.add('hidden');
        
        // Validate form
        let isValid = true;
        
        if (!firstName) {
          elements.firstNameError.textContent = 'El nombre es requerido';
          elements.firstNameError.classList.remove('hidden');
          isValid = false;
        }
        
        if (!lastName) {
          elements.lastNameError.textContent = 'El apellido es requerido';
          elements.lastNameError.classList.remove('hidden');
          isValid = false;
        }
        
        if (!phoneNumber) {
          elements.phoneNumberError.textContent = 'El nÃºmero de telÃ©fono es requerido';
          elements.phoneNumberError.classList.remove('hidden');
          isValid = false;
        }
        
        if (!relationship) {
          elements.relationshipError.textContent = 'La relaciÃ³n es requerida';
          elements.relationshipError.classList.remove('hidden');
          isValid = false;
        }
        
        if (!isValid) {
          return;
        }
        
        // Calculate points (mÃ¡s puntos para los primeros referidos)
        const basePoints = 100;
        const earlyBonus = Math.max(0, 10 - referrals.length) * 20;
        const totalPointsForReferral = basePoints + earlyBonus;
        
        try {
          // Add referral to database with initial status 'pendiente'
          const { data, error } = await supabase
            .from('referrals')
            .insert([
              {
                user_id: currentUser.id,
                first_name: firstName,
                last_name: lastName,
                phone_number: phoneNumber,
                relationship: relationship,
                points: totalPointsForReferral,
                status: 'pendiente' // Initial status
              }
            ])
            .select()
            .single();
          
          if (error) throw error;
          
          // Create new referral object
          const newReferral = {
            id: data.id,
            firstName,
            lastName,
            phoneNumber,
            relationship,
            date: new Date(data.created_at),
            points: totalPointsForReferral,
            status: 'pendiente'
          };
          
          // Add to list
          referrals.push(newReferral);
          
          // Update user's total points and last referral date
          const newTotalPoints = currentUser.totalPoints + totalPointsForReferral;
          const { error: updateError } = await supabase
            .from('users')
            .update({ 
              total_points: newTotalPoints,
              last_referral_date: new Date().toISOString()
            })
            .eq('id', currentUser.id);
          
          if (updateError) throw updateError;
          
          // Update current user data
          currentUser.totalPoints = newTotalPoints;
          currentUser.lastReferralDate = new Date();
          
          // Update UI
          updateReferralsList();
          updateProgress();
          updateLevel();
          updateRewardsList();
          updateNextReward();
          
          // Check for bonuses y celebraciÃ³n
          let bonusMessage = "";
          let isSpecialReward = false;
          
          // Check for tanque lleno (2 referrals in any status)
          if (referrals.length >= 2 && !rewards[0].claimed) {
            bonusMessage = "Â¡TANQUE LLENO DESBLOQUEADO! ð";
            recentBonus = rewards[0].id;
            await claimReward(rewards[0].id);
            triggerAdvancedConfetti();
            showCelebrationOverlay("Has ganado un TANQUE LLENO");
            isSpecialReward = true;
          } 
          // Check for cuota bonificada (4 referrals with status 'compro_auto')
          else if (countReferralsWithStatus('compro_auto') >= 4 && !rewards[1].claimed) {
            bonusMessage = "Â¡BONIFICACIÃN DE $200.000! ð";
            recentBonus = rewards[1].id;
            await claimReward(rewards[1].id);
            triggerAdvancedConfetti();
            showCelebrationOverlay("Has ganado una BONIFICACIÃN DE $200.000");
            isSpecialReward = true;
          } 
          // Check for transferencia bonificada (10 referrals in any status)
          else if (referrals.length >= 10 && !rewards[2].claimed) {
            bonusMessage = "Â¡TRANSFERENCIA BONIFICADA AL 100%! ð";
            recentBonus = rewards[2].id;
            await claimReward(rewards[2].id);
            triggerAdvancedConfetti();
            showCelebrationOverlay("Has ganado una TRANSFERENCIA BONIFICADA AL 100%");
            isSpecialReward = true;
          }
          
          if (bonusMessage) {
            showToast(bonusMessage, "Â¡Has desbloqueado una bonificaciÃ³n exclusiva!", 'special');
            
            // Auto switch to bonuses tab after a short delay
            setTimeout(() => {
              switchTab('bonuses');
            }, 1500);
          } else {
            // Regular toast for non-special rewards
            showToast(`Â¡Referido agregado con Ã©xito! +${totalPointsForReferral} puntos`, 
                      `Â¡Sigue sumando referidos para desbloquear increÃ­bles bonificaciones!`, 
                      'success');
            
            // Small confetti for regular additions
            triggerConfetti();
          }
          
          // Reset form
          firstName = '';
          lastName = '';
          phoneNumber = '';
          relationship = '';
          
          elements.firstNameInput.value = '';
          elements.lastNameInput.value = '';
          elements.phoneNumberInput.value = '';
          elements.relationshipSelect.value = '';
          
          // Show tips occasionally
          if (Math.random() > 0.7 && !isSpecialReward) {
            setTimeout(() => {
              showTipsPopup();
            }, 1000);
          }
          
          // Check streak
          updateStreak();
          
        } catch (error) {
          console.error('Error adding referral:', error);
          showToast('Error', 'No se pudo agregar el referido', 'error');
        }
      }
      
      // Helper function to count referrals with a specific status
      function countReferralsWithStatus(status) {
        return referrals.filter(ref => ref.status === status).length;
      }
      
      async function updateReferralStatus(referralId, newStatus) {
        try {
          // Update status in database
          const { error } = await supabase
            .from('referrals')
            .update({ status: newStatus })
            .eq('id', referralId);
          
          if (error) throw error;
          
          // Update local referral object
          const referral = referrals.find(ref => ref.id === referralId);
          if (referral) {
            referral.status = newStatus;
          }
          
          // Update UI
          updateReferralsList();
          
          // Check if this status change triggers any rewards
          checkRewardsAfterStatusChange();
          
          showToast('Estado Actualizado', `El estado del referido ha sido actualizado a "${newStatus}"`, 'success');
        } catch (error) {
          console.error('Error updating referral status:', error);
          showToast('Error', 'No se pudo actualizar el estado del referido', 'error');
        }
      }
      
      async function checkRewardsAfterStatusChange() {
        // Check for cuota bonificada (4 referrals with status 'compro_auto')
        if (countReferralsWithStatus('compro_auto') >= 4 && !rewards[1].claimed) {
          await claimReward(rewards[1].id);
          triggerAdvancedConfetti();
          showCelebrationOverlay("Has ganado una Â¡BONIFICACIÃN DE $200.000!");
          showToast("Â¡BONIFICACIÃN DE $200.000! ð", "Â¡Has desbloqueado una bonificaciÃ³n exclusiva!", 'special');
          
          // Update UI
          updateRewardsList();
          updateNextReward();
        }
      }
      
      async function claimReward(rewardId) {
        try {
          // First check if the reward exists in the rewards table
          const { data: rewardExists, error: checkError } = await supabase
            .from('rewards')
            .select('id')
            .eq('id', rewardId)
            .single();
          
          if (checkError || !rewardExists) {
            console.error('Error claiming reward: Reward does not exist in database', { rewardId });
            showToast('Error', 'No se pudo reclamar la bonificaciÃ³n. Por favor contacta a soporte.', 'error');
            return false;
          }
          
          // If reward exists, proceed with claiming it
          const { error } = await supabase
            .from('user_rewards')
            .insert([
              {
                user_id: currentUser.id,
                reward_id: rewardId
              }
            ]);
          
          if (error) {
            console.error('Error claiming reward:', error);
            throw error;
          }
          
          // Mark reward as claimed
          const reward = rewards.find(r => r.id === rewardId);
          if (reward) {
            reward.claimed = true;
          }
          
          return true;
        } catch (error) {
          console.error('Error claiming reward:', error);
          return false;
        }
      }
      
      function updateReferralsList() {
        // Update counts
        elements.referralCount.textContent = referrals.length;
        elements.tabReferralCount.textContent = referrals.length;
        elements.progressReferralCount.textContent = referrals.length;
        
        // Update description
        if (referrals.length === 0) {
          elements.referralListDescription.textContent = "Â¡Comienza a agregar referidos para obtener increÃ­bles bonificaciones!";
        } else {
          elements.referralListDescription.textContent = `Has agregado ${referrals.length} ${referrals.length === 1 ? 'referido' : 'referidos'}. Â¡Sigue sumando para mÃ¡s beneficios!`;
        }
        
        // Show/hide empty state
        if (referrals.length === 0) {
          elements.emptyReferralList.classList.remove('hidden');
          elements.referralListContent.classList.add('hidden');
          elements.referralListFooter.classList.add('hidden');
        } else {
          elements.emptyReferralList.classList.add('hidden');
          elements.referralListContent.classList.remove('hidden');
          elements.referralListFooter.classList.remove('hidden');
          
          // Update remaining referrals text - Siempre mostrar el botÃ³n para agregar mÃ¡s
          elements.remainingReferralsFooter.textContent = `ContinÃºa agregando referidos para obtener mÃ¡s bonificaciones`;
          
          // Clear and rebuild referrals list
          elements.referralsList.innerHTML = '';
          
          referrals.forEach((referral, index) => {
            const referralElement = document.createElement('div');
            referralElement.className = 'flex items-center justify-between p-4 border border-blue-100 rounded-lg hover:bg-blue-50 transition-colors animate-fade-in';
            referralElement.style.animationDelay = `${index * 0.1}s`;
            
            let relationshipText = '';
            switch(referral.relationship) {
              case 'family': relationshipText = 'Familiar'; break;
              case 'friend': relationshipText = 'Amigo'; break;
              case 'colleague': relationshipText = 'Colega'; break;
              case 'other': relationshipText = 'Otro'; break;
            }
            
            // Get status badge color based on status
            let statusBadgeClass = 'bg-blue-100 text-blue-800';
            let statusText = 'Pendiente';
            
            switch(referral.status) {
              case 'pendiente':
                statusBadgeClass = 'bg-blue-100 text-blue-800';
                statusText = 'Pendiente';
                break;
              case 'en_comunicacion':
                statusBadgeClass = 'bg-yellow-100 text-yellow-800';
                statusText = 'En ComunicaciÃ³n';
                break;
              case 'compro_auto':
                statusBadgeClass = 'bg-green-100 text-green-800';
                statusText = 'ComprÃ³ su Auto';
                break;
            }
            
            referralElement.innerHTML = `
              <div class="flex items-center">
                <div class="bg-gradient-to-r from-blue-500 to-purple-500 w-10 h-10 rounded-full flex items-center justify-center text-white font-bold mr-4">
                  ${referral.firstName.charAt(0)}${referral.lastName.charAt(0)}
                </div>
                <div>
                  <h3 class="font-medium text-blue-800">${referral.firstName} ${referral.lastName}</h3>
                  <p class="text-sm text-blue-600">${referral.phoneNumber}</p>
                  <div class="flex items-center">
                    <p class="text-xs text-blue-400 mr-2">${relationshipText}</p>
                    <span class="badge bg-blue-50 text-blue-600 border-blue-200 text-xs">
                      +${referral.points} pts
                    </span>
                  </div>
                </div>
              </div>
              <div class="flex flex-col items-end">
                <div class="${statusBadgeClass} px-2 py-1 rounded text-xs font-medium mb-1">
                  ${statusText}
                </div>
                <div class="flex mb-1">
                  <select class="status-select text-xs border border-gray-200 rounded p-1" data-referral-id="${referral.id}">
                    <option value="pendiente" ${referral.status === 'pendiente' ? 'selected' : ''}>Pendiente</option>
                    <option value="en_comunicacion" ${referral.status === 'en_comunicacion' ? 'selected' : ''}>En ComunicaciÃ³n</option>
                    <option value="compro_auto" ${referral.status === 'compro_auto' ? 'selected' : ''}>ComprÃ³ su Auto</option>
                  </select>
                </div>
                <p class="text-xs text-gray-500">
                  ${new Date(referral.date).toLocaleDateString()}
                </p>
              </div>
            `;
            
            elements.referralsList.appendChild(referralElement);
          });
          
          // Add event listeners to status selects
          document.querySelectorAll('.status-select').forEach(select => {
            select.addEventListener('change', (e) => {
              const referralId = e.target.getAttribute('data-referral-id');
              const newStatus = e.target.value;
              updateReferralStatus(referralId, newStatus);
            });
          });
        }
      }
      
      function updateProgress() {
        // Calculate progress percentage (no limit at 100% to allow progress beyond 10 referrals)
        progress = Math.min(100, (referrals.length / 10) * 100);
        
        // Update progress bar
        elements.mainProgress.style.width = `${progress}%`;
        
        // Update milestones
        if (referrals.length >= 2) {
          elements.milestone1.classList.remove('bg-gray-300');
          elements.milestone1.classList.add('bg-green-500');
          elements.milestone1.innerHTML = `
            <svg class="w-3 h-3 text-white" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          `;
        }
        
        if (countReferralsWithStatus('compro_auto') >= 4) {
          elements.milestone2.classList.remove('bg-gray-300');
          elements.milestone2.classList.add('bg-green-500');
          elements.milestone2.innerHTML = `
            <svg class="w-3 h-3 text-white" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          `;
        }
        
        if (referrals.length >= 10) {
          elements.milestone3.classList.remove('bg-gray-300');
          elements.milestone3.classList.add('bg-green-500');
          elements.milestone3.innerHTML = `
            <svg class="w-3 h-3 text-white" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          `;
        }
      }
      
      async function updateLevel() {
        if (!currentUser) return;
        
        // Calculate total points
        totalPoints = currentUser.totalPoints;
        
        // Calculate level
        const newLevel = Math.floor(referrals.length / 3) + 1;
        
        // Update level if increased
        if (newLevel > level) {
          // Update level in database
          try {
            const { error } = await supabase
              .from('users')
              .update({ level: newLevel })
              .eq('id', currentUser.id);
            
            if (error) throw error;
            
            // Update current user data
            currentUser.level = newLevel;
            
            showToast(`Â¡Nivel ${newLevel} Desbloqueado!`, 
                      "Has subido de nivel. Â¡Sigue asÃ­ para desbloquear mÃ¡s beneficios!", 
                      'special');
          } catch (error) {
            console.error('Error updating level:', error);
          }
        }
        
        level = newLevel;
        
        // Update UI
        elements.userLevel.textContent = level;
        elements.totalPoints.textContent = totalPoints;
        elements.statsTotalPoints.textContent = totalPoints;
        elements.statsLevel.textContent = level;
        
        // Update position
        const position = Math.max(1, 10 - referrals.length);
        elements.statsPosition.textContent = `Top ${position}%`;
        elements.topPercentage.textContent = position;
        
        // Show top badge if referrals > 0
        if (referrals.length > 0) {
          elements.topBadge.classList.remove('hidden');
        }
      }
      
      function updateRewardsList() {
        // Clear rewards list
        elements.rewardsList.innerHTML = '';
        
        // Add rewards
        rewards.forEach((reward, index) => {
          const rewardElement = document.createElement('div');
          rewardElement.className = `relative overflow-hidden rounded-xl border ${reward.claimed ? 'border-green-200 bg-green-50' : 'border-gray-200 bg-gray-50'} animate-fade-in`;
          rewardElement.style.animationDelay = `${0.1 * index}s`;
          
          let iconSvg = '';
          switch(reward.icon) {
            case 'gift':
              iconSvg = `<svg class="h-8 w-8 ${reward.claimed ? 'text-green-500' : 'text-gray-400'}" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 12 20 22 4 22 4 12"></polyline>
                <rect x="2" y="7" width="20" height="5"></rect>
                <line x1="12" y1="22" x2="12" y2="7"></line>
                <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path>
                <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
              </svg>`;
              break;
            case 'star':
              iconSvg = `<svg class="h-8 w-8 ${reward.claimed ? 'text-green-500' : 'text-gray-400'}" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg>`;
              break;
            case 'trophy':
              iconSvg = `<svg class="h-8 w-8 ${reward.claimed ? 'text-green-500' : 'text-gray-400'}" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                <path d="M4 22h16"></path>
                <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
                <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
              </svg>`;
              break;
          }
          
          // Determine progress and requirements text based on reward type
          let progressCount = referrals.length;
          let requirementText = '';
          
          if (reward.requiresStatus === 'compro_auto') {
            progressCount = countReferralsWithStatus('compro_auto');
            requirementText = ' que compren su auto';
          }
          
          // Mostrar "Objetivo Cumplido" cuando se ha reclamado la recompensa
          const objetivoCumplidoBadge = reward.claimed ? 
            `<span class="objetivo-cumplido">
              <svg class="inline-block mr-1 h-3 w-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
              Objetivo Cumplido
            </span>` : '';
          
          rewardElement.innerHTML = `
            ${reward.claimed ? `
              <div class="absolute top-0 right-0">
                <div class="bg-green-500 text-white text-xs font-bold px-3 py-1 transform rotate-45 translate-x-2 translate-y-1">
                  Â¡TUYO!
                </div>
              </div>
            ` : ''}
            
            <div class="p-6">
              <div class="flex items-start">
                <div class="p-3 rounded-full mr-4 ${reward.claimed ? 'bg-green-100' : 'bg-gray-100'}">
                  ${iconSvg}
                </div>
                <div class="flex-1">
                  <h3 class="text-xl font-bold ${reward.claimed ? 'text-green-700' : 'text-gray-700'} flex items-center">
                    ${reward.name}
                    ${objetivoCumplidoBadge}
                  </h3>
                  <p class="text-sm ${reward.claimed ? 'text-green-600' : 'text-gray-500'}">
                    ${reward.description}
                  </p>
                  
                  ${reward.claimed ? `
                    <div class="mt-2">
                      <span class="badge bg-green-100 text-green-700 hover:bg-green-200 border-none">
                        Recompensa Desbloqueada
                      </span>
                    </div>
                  ` : ''}
                </div>
                <div class="ml-4">
                  ${reward.claimed ? `
                    <div class="bg-green-100 text-green-700 font-bold rounded-full h-12 w-12 flex items-center justify-center">
                      <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                      </svg>
                    </div>
                  ` : `
                    <div class="relative h-12 w-12">
                      <div class="absolute inset-0 rounded-full bg-gray-200 flex items-center justify-center">
                        <span class="text-gray-600 font-bold">${Math.min(progressCount, reward.requiredReferrals)}/${reward.requiredReferrals}</span>
                      </div>
                      <svg class="absolute inset-0" width="48" height="48" viewBox="0 0 48 48">
                        <circle 
                          cx="24" cy="24" r="20" 
                          fill="none" 
                          stroke="#e5e7eb" 
                          strokeWidth="4" 
                        />
                        <circle 
                          cx="24" cy="24" r="20" 
                          fill="none" 
                          stroke="#4ade80" 
                          strokeWidth="4" 
                          strokeDasharray="125.6" 
                          strokeDashoffset="${125.6 - (125.6 * Math.min(progressCount / reward.requiredReferrals, 1))}" 
                          strokeLinecap="round"
                          transform="rotate(-90 24 24)" 
                        />
                      </svg>
                    </div>
                  `}
                </div>
              </div>
              
              ${!reward.claimed && progressCount < reward.requiredReferrals ? `
                <div class="mt-4">
                  <button 
                    class="btn-primary w-full bg-blue-600 hover:bg-blue-700 add-more-button"
                    data-required="${reward.requiredReferrals - progressCount}"
                  >
                    Agregar ${reward.requiredReferrals - progressCount} referido${reward.requiredReferrals - progressCount > 1 ? 's' : ''}${requirementText} mÃ¡s
                  </button>
                </div>
              ` : ''}
            </div>
          `;
          
          elements.rewardsList.appendChild(rewardElement);
        });
        
        // Add VIP reward if level >= 3
        if (level >= 3) {
          const vipRewardElement = document.createElement('div');
          vipRewardElement.className = 'relative overflow-hidden rounded-xl border border-purple-200 bg-purple-50 animate-fade-in';
          vipRewardElement.style.animationDelay = '0.4s';
          
          vipRewardElement.innerHTML = `
            <div class="absolute top-0 right-0">
              <div class="bg-purple-500 text-white text-xs font-bold px-3 py-1 transform rotate-45 translate-x-2 translate-y-1">
                NIVEL 3+
              </div>
            </div>
            
            <div class="p-6">
              <div class="flex items-start">
                <div class="p-3 rounded-full mr-4 bg-purple-100">
                  <svg class="h-8 w-8 text-purple-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
                  </svg>
                </div>
                <div class="flex-1">
                  <h3 class="text-xl font-bold text-purple-700 flex items-center">
                    Beneficios VIP
                    <span class="objetivo-cumplido" style="background-color: #9333ea;">
                      <svg class="inline-block mr-1 h-3 w-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                      </svg>
                      Objetivo Cumplido
                    </span>
                  </h3>
                  <p class="text-sm text-purple-600">
                    Acceso a ofertas exclusivas y atenciÃ³n prioritaria.
                  </p>
                  
                  <div class="mt-2">
                    <span class="badge bg-purple-100 text-purple-700 hover:bg-purple-200 border-none">
                      Beneficio por Nivel
                    </span>
                  </div>
                </div>
                <div class="ml-4">
                  <div class="bg-purple-100 text-purple-700 font-bold rounded-full h-12 w-12 flex items-center justify-center">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                      <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          elements.rewardsList.appendChild(vipRewardElement);
        }
        
        // Show/hide complete footer
        if (rewards.every(r => r.claimed)) {
          elements.bonusesFooterIncomplete.classList.add('hidden');
          elements.bonusesFooterComplete.classList.remove('hidden');
        } else {
          elements.bonusesFooterIncomplete.classList.remove('hidden');
          elements.bonusesFooterComplete.classList.add('hidden');
        }
      }
      
      function updateNextReward() {
        const nextReward = getNextReward();
        
        if (nextReward) {
          elements.nextRewardContainer.classList.remove('hidden');
          elements.nextRewardName.textContent = nextReward.name;
          
          // Determine progress count based on reward type
          let progressCount = referrals.length;
          if (nextReward.requiresStatus === 'compro_auto') {
            progressCount = countReferralsWithStatus('compro_auto');
          }
          
          elements.currentReferrals.textContent = progressCount;
          elements.requiredReferrals.textContent = nextReward.requiredReferrals;
          
          const progress = Math.min(100, (progressCount / nextReward.requiredReferrals) * 100);
          elements.nextRewardProgress.style.width = `${progress}%`;
          
          const remaining = Math.max(0, nextReward.requiredReferrals - progressCount);
          
          let requirementText = '';
          if (nextReward.requiresStatus === 'compro_auto') {
            requirementText = ' que compren su auto';
          }
          
          if (remaining > 0) {
            elements.remainingReferralsText.textContent = `Te faltan ${remaining} referido${remaining > 1 ? 's' : ''}${requirementText} para desbloquear esta recompensa`;
          } else {
            elements.remainingReferralsText.textContent = `Â¡Has completado los requisitos para esta recompensa!`;
          }
        } else {
          // Si no hay prÃ³xima recompensa, mostrar mensaje para seguir agregando referidos
          elements.nextRewardContainer.classList.remove('hidden');
          elements.nextRewardName.textContent = "Todas las bonificaciones desbloqueadas";
          elements.currentReferrals.textContent = referrals.length;
          elements.requiredReferrals.textContent = referrals.length;
          elements.nextRewardProgress.style.width = "100%";
          elements.remainingReferralsText.textContent = "Â¡Sigue agregando referidos para obtener mÃ¡s puntos y subir de nivel!";
        }
      }
      
      function getNextReward() {
        // Find the first unclaimed reward
        return rewards.find(reward => !reward.claimed);
      }
      
      async function updateStreak() {
        if (!currentUser || referrals.length === 0) return;
        
        const lastDate = new Date(referrals[referrals.length - 1].date);
        lastReferralDate = lastDate;
        
        // Si se agregÃ³ un referido hoy y el anterior fue ayer, aumentar la racha
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        
        if (lastDate.toDateString() === today.toDateString() && 
            referrals.length > 1 && 
            new Date(referrals[referrals.length - 2].date).toDateString() === yesterday.toDateString()) {
          streak++;
          
          // Update streak in database
          try {
            const { error } = await supabase
              .from('users')
              .update({ streak: streak })
              .eq('id', currentUser.id);
            
            if (error) throw error;
            
            // Update current user data
            currentUser.streak = streak;
            
            if (streak >= 2) {
              displayStreakBadge();
            }
          } catch (error) {
            console.error('Error updating streak:', error);
          }
        }
        
        // Update streak badges
        elements.streakCount.textContent = streak;
        elements.streakCountSmall.textContent = streak;
        
        if (streak > 0) {
          elements.streakBadgeSmall.classList.remove('hidden');
        }
      }
      
      function displayStreakBadge() {
        elements.streakBadge.classList.remove('hidden');
        setTimeout(() => {
          elements.streakBadge.classList.add('hidden');
        }, 5000);
      }
      
      function showTipsPopup() {
        // Random tip
        const tips = [
          "Comparte tu enlace de referido en grupos de WhatsApp para conseguir mÃ¡s referidos rÃ¡pidamente.",
          "Los referidos familiares tienen un 30% mÃ¡s de probabilidad de convertirse en clientes activos.",
          "Agrega referidos en dÃ­as consecutivos para mantener tu racha y obtener bonificaciones extra.",
          "Comparte tus bonificaciones en redes sociales para motivar a otros a unirse.",
          "Â¡Puedes seguir agregando referidos incluso despuÃ©s de alcanzar las 10 bonificaciones!"
        ];
        
        elements.tipContent.textContent = tips[Math.floor(Math.random() * tips.length)];
        elements.tipsPopup.classList.remove('hidden');
        
        setTimeout(() => {
          elements.tipsPopup.classList.add('hidden');
        }, 8000);
      }
      
      function updateLimitedTimeOffer() {
        if (showLimitedTimeOffer && countdown !== null) {
          elements.limitedTimeOffer.classList.remove('hidden');
          
          // Update countdown
          const minutes = Math.floor(countdown / 60);
          const seconds = countdown % 60;
          elements.countdownTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
          
          // Update progress
          elements.countdownProgress.style.width = `${(countdown / 1800) * 100}%`;
          
          // Countdown timer
          if (countdown > 0) {
            setTimeout(() => {
              countdown--;
              updateLimitedTimeOffer();
            }, 1000);
          } else {
            elements.limitedTimeOffer.classList.add('hidden');
            showLimitedTimeOffer = false;
          }
        } else {
          elements.limitedTimeOffer.classList.add('hidden');
        }
      }
      
      function setupPulseAnimation() {
        setInterval(() => {
          elements.pulseDot.classList.remove('hidden');
          setTimeout(() => {
            elements.pulseDot.classList.add('hidden');
          }, 2000);
        }, 10000);
      }
      
      function createSparkles() {
        const sparklesContainer = document.querySelector('.sparkles-container');
        
        for (let i = 0; i < 20; i++) {
          const sparkle = document.createElement('div');
          sparkle.className = 'sparkle';
          sparkle.style.left = `${Math.random() * 100}%`;
          sparkle.style.top = `${Math.random() * 100}%`;
          sparkle.style.animationDelay = `${Math.random() * 3}s`;
          sparkle.style.animationDuration = `${2 + Math.random() * 3}s`;
          
          sparklesContainer.appendChild(sparkle);
        }
      }
      
      function showCelebrationOverlay(message) {
        elements.celebrationMessage.textContent = message;
        elements.celebrationOverlay.classList.remove('hidden');
        showCelebration = true;
        
        // Auto hide after 5 seconds
        setTimeout(() => {
          elements.celebrationOverlay.classList.add('hidden');
          showCelebration = false;
        }, 5000);
      }
      
      function triggerConfetti() {
        const duration = 3 * 1000;
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
        
        const randomInRange = (min, max) => {
          return Math.random() * (max - min) + min;
        };
        
        const interval = setInterval(() => {
          const timeLeft = animationEnd - Date.now();
          
          if (timeLeft <= 0) {
            clearInterval(interval);
            return;
          }
          
          const particleCount = 50 * (timeLeft / duration);
          
          // Since particles fall down, start a bit higher than random
          confetti({
            ...defaults,
            particleCount,
            origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
          });
          confetti({
            ...defaults,
            particleCount,
            origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
          });
        }, 100);
      }
      
      function triggerAdvancedConfetti() {
        const duration = 8 * 1000;
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
        
        const randomInRange = (min, max) => {
          return Math.random() * (max - min) + min;
        };
        
        // Run the confetti animation in multiple bursts for a more dramatic effect
        const interval = setInterval(() => {
          const timeLeft = animationEnd - Date.now();
          
          if (timeLeft <= 0) {
            clearInterval(interval);
            return;
          }
          
          const particleCount = 100 * (timeLeft / duration);
          
          // Multiple origins for a fuller effect
          confetti({
            ...defaults,
            particleCount,
            origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
          });
          confetti({
            ...defaults,
            particleCount,
            origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
          });
          confetti({
            ...defaults,
            particleCount,
            origin: { x: randomInRange(0.4, 0.6), y: Math.random() - 0.2 }
          });
        }, 250);
      }
      
      function shareReferralLink() {
        // Check if Web Share API is available
        if (navigator.share) {
          navigator.share({
            title: 'Ãnete con mi cÃ³digo de referido',
            text: `Â¡Usa mi cÃ³digo de referido ${elements.referralCode.textContent} para obtener beneficios exclusivos!`,
            url: window.location.href
          })
          .then(() => {
            showToast('Â¡Compartido!', 'Tu cÃ³digo de referido ha sido compartido exitosamente', 'success');
          })
          .catch((error) => {
            console.error('Error sharing:', error);
          });
        } else {
          // Fallback for browsers that don't support the Web Share API
          try {
            const textArea = document.createElement('textarea');
            textArea.value = `Â¡Usa mi cÃ³digo de referido ${elements.referralCode.textContent} para obtener beneficios exclusivos! ${window.location.href}`;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            showToast('Â¡Copiado!', 'Enlace copiado al portapapeles', 'success');
          } catch (err) {
            console.error('Error copying to clipboard:', err);
            showToast('Error', 'No se pudo copiar el enlace', 'error');
          }
        }
        
        // Close share drawer if open
        if (showShareDrawer) {
          elements.shareDrawer.classList.add('hidden');
          showShareDrawer = false;
        }
      }
      
      function showToast(title, message, type = 'default') {
        const toast = document.createElement('div');
        toast.className = `toast ${type ? `toast-${type}` : ''}`;
        
        toast.innerHTML = `
          <div class="toast-title">${title}</div>
          <div class="toast-description">${message}</div>
        `;
        
        elements.toastContainer.appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(1rem)';
          toast.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
          
          setTimeout(() => {
            elements.toastContainer.removeChild(toast);
          }, 300);
        }, 5000);
      }
      
      // Add event listeners to "Add More" buttons in rewards list
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('add-more-button')) {
          switchTab('add');
        }
      });
      
      // ImplementaciÃ³n de inicio de sesiÃ³n con cÃ³digo Ãºnico
      async function handleCodeLogin(e) {
        e.preventDefault();

        // Reset errors
        elements.codeLoginError.classList.add('hidden');
        elements.codeLoginError.textContent = '';
        elements.codeError.classList.add('hidden');
        elements.codeError.textContent = '';

        // Get form values
        const uniqueCode = elements.uniqueCode.value.trim();

        // Validate form
        if (!uniqueCode) {
          elements.codeError.textContent = 'Por favor ingresa tu cÃ³digo Ãºnico';
          elements.codeError.classList.remove('hidden');
          return;
        }

        // Show loading state
        elements.codeLoginSpinner.classList.remove('hidden');
        elements.codeLoginButtonText.textContent = 'Iniciando sesiÃ³n...';
        elements.codeLoginButton.disabled = true;

        try {
          // Find user by access code
          const { data: userData, error: userError } = await supabase
            .from('users')
            .select('*')
            .eq('access_code', uniqueCode)
            .single();
          
          if (userError || !userData) {
            elements.codeLoginError.textContent = 'CÃ³digo no vÃ¡lido. Por favor verifica e intenta nuevamente.';
            elements.codeLoginError.classList.remove('hidden');
            throw new Error('Invalid access code');
          }

          // Store the user data in localStorage
          localStorage.setItem('referralSystemUser', JSON.stringify({
            id: userData.id,
            email: userData.email,
            name: userData.name,
            totalPoints: userData.total_points,
            level: userData.level,
            streak: userData.streak,
            lastReferralDate: userData.last_referral_date,
            lastResetDate: userData.last_reset_date,
            accessCode: userData.access_code
          }));
          
          // Set a flag to indicate we're using the code login method
          localStorage.setItem('referralSystemCodeLogin', 'true');
          
          // Create a session manually
          currentUser = {
            id: userData.id,
            email: userData.email,
            name: userData.name,
            totalPoints: userData.total_points,
            level: userData.level,
            streak: userData.streak,
            lastReferralDate: userData.last_referral_date,
            lastResetDate: userData.last_reset_date,
            accessCode: userData.access_code
          };
          
          // Update UI
          elements.loginModal.classList.add('hidden');
          elements.registerModal.classList.add('hidden');
          elements.logoutButton.classList.remove('hidden');
          
          // Set access code
          elements.referralCode.textContent = currentUser.accessCode;
          
          // Load user's referrals
          await loadReferrals();
          
          // Update UI
          updateReferralsList();
          updateProgress();
          updateLevel();
          updateRewardsList();
          updateNextReward();

          // Update last login timestamp
          await supabase
            .from('users')
            .update({ last_login: new Date().toISOString() })
            .eq('id', userData.id);

          // Show success message
          showToast('Â¡Bienvenido!', 'Has iniciado sesiÃ³n exitosamente', 'success');

        } catch (error) {
          console.error('Error logging in with code:', error);
          elements.codeLoginError.textContent = error.message || 'Error al iniciar sesiÃ³n. IntÃ©ntalo de nuevo.';
          elements.codeLoginError.classList.remove('hidden');
        } finally {
          // Reset loading state
          elements.codeLoginSpinner.classList.add('hidden');
          elements.codeLoginButtonText.textContent = 'Iniciar SesiÃ³n con CÃ³digo';
          elements.codeLoginButton.disabled = false;
        }
      }
    });
  </script>
  </body>
  </html>
